<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>BDE 3.0: bslma_testallocatorexception Component</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <style>
      div.hanging {
        padding-left: 0.75in;
        text-indent: -0.50in;
      }
      div.unhanging {
        text-indent:     0in;
      }
      a.glossary {
        font-weight: bold;
        font-style: italic;
      }
    </style>
</head>
<!--
<body onload='searchBox.OnSelectItem(0);'>
-->
<body>

<table border=2 cellspacing=0 cellpadding=0 align=center>
<tr>
 <td valign=top align=center>
 <p align=center><b><i>Quick Links:</i></b></p>
 </td>
 <td valign=top align=center>
 <p align=center>
<a class="qindex" href="group__bal.html" target="_blank">bal</a> | <a class="qindex" href="group__bbl.html" target="_blank">bbl</a> | <a class="qindex" href="group__bdl.html" target="_blank">bdl</a> | <a class="qindex" href="group__bsl.html" target="_blank">bsl</a> | <a class="qindex" href="group__btl.html" target="_blank">btl</a>
 </td>
 </tr>
 </table>

  </div>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="components.html"><span>Components</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#namespaces">Namespaces</a>  </div>
  <div class="headertitle">
<h1>Component bslma_testallocatorexception<br/>
<small>
[<a class="el" href="group__bslma.html">Package bslma</a>]</small>
</h1>  </div>
</div>
<div class="contents">

<p>Provide an exception class for memory allocation operations.  
<a href="#_details">More...</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacebslma.html">bslma</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<dl class="user"><dt><b>Outline</b></dt><dd><ul>
<li>
<a href="#1">Purpose</a> </li>
<li>
<a href="#2">Classes</a> </li>
<li>
<a href="#3">Description</a> <ul>
<li>
<a href="#3.1">Usage</a> </li>
</ul>
</li>
</ul>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="purpose"></a> <a class="anchor" id="1"></a> </dd></dl>
<dl class="user"><dt><b>Purpose: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>Provide an exception class for memory allocation operations. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="classes"></a> <a class="anchor" id="2"></a> </dd></dl>
<dl class="user"><dt><b>Classes: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><table class="doxtable">
<tr>
<td><a class="el" href="classbslma_1_1TestAllocatorException.html">bslma::TestAllocatorException</a> </td><td>exception containing allocation information  </td></tr>
</table>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="description"></a> <a class="anchor" id="3"></a> </dd></dl>
<dl class="user"><dt><b>Description: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>This component defines a simple exception object for testing exceptions during memory allocation operations. The exception object <code><a class="el" href="classbslma_1_1TestAllocatorException.html">bslma::TestAllocatorException</a></code> contains information about the allocation request, which can be queried for by the "catcher" of this exception. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="usage"></a> <a class="anchor" id="description.usage"></a> <a class="anchor" id="3.1"></a> </dd></dl>
<dl class="user"><dt><b>Usage: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>In the following example, the <code><a class="el" href="classbslma_1_1TestAllocatorException.html">bslma::TestAllocatorException</a></code> object is thrown by the <code>allocate</code> method of the <code>my_Allocator</code> object after the number of allocation requests exceeds the allocator's allocation limit. This example demonstrates how to use a user-defined allocator (e.g., <code>my_Allocator</code>) and <code><a class="el" href="classbslma_1_1TestAllocatorException.html">bslma::TestAllocatorException</a></code> to verify that an object (e.g., <code>my_ShortArray</code>) under test is exception-neutral: <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="comment">// my_allocator.h</span>
<span class="preprocessor">  #include &lt;<a class="code" href="bslma__allocator_8h.html" title="Provide a pure abstract interface for memory-allocation mechanisms.">bslma_allocator.h</a>&gt;</span>

  <span class="keyword">class </span>my_Allocator : <span class="keyword">public</span> bslma::Allocator {
      <span class="keywordtype">int</span> d_allocationLimit;
      <span class="comment">// ...</span>

    <span class="keyword">private</span>:
      <span class="comment">// NOT IMPLEMENTED</span>
      my_Allocator(<span class="keyword">const</span> my_Allocator&amp;);
      my_Allocator&amp; operator=(<span class="keyword">const</span> my_Allocator&amp;);

    <span class="keyword">public</span>:
      <span class="comment">// CREATORS</span>
      my_Allocator() : d_allocationLimit(-1) {}
      ~my_Allocator() {}

      <span class="keywordtype">void</span> *allocate(<span class="keywordtype">int</span> <a class="code" href="namespacebdlat__ArrayFunctions.html#a65e1cfba76b2d13054b61159488b0da8">size</a>);
      <span class="keywordtype">void</span> deallocate(<span class="keywordtype">void</span> *address) { free(address); }
      <span class="keywordtype">void</span> setAllocationLimit(<span class="keywordtype">int</span> limit){ d_allocationLimit = limit; }
      <span class="keywordtype">int</span> allocationLimit()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> d_allocationLimit; }
      <span class="comment">// ...</span>
  };

  <span class="comment">// my_allocator.cpp</span>
<span class="preprocessor">  #include &lt;my_allocator.h&gt;</span>

  <span class="keywordtype">void</span> *my_Allocator::allocate(<span class="keywordtype">int</span> <a class="code" href="namespacebdlat__ArrayFunctions.html#a65e1cfba76b2d13054b61159488b0da8">size</a>)
  {
<span class="preprocessor">  #ifdef BDE_BUILD_TARGET_EXC</span>
<span class="preprocessor"></span>      <span class="keywordflow">if</span> (0 &lt;= d_allocationLimit) {
          --d_allocationLimit;
          <span class="keywordflow">if</span> (0 &gt; d_allocationLimit) {
              <span class="keywordflow">throw</span> <a class="code" href="classbslma_1_1TestAllocatorException.html">bslma::TestAllocatorException</a>(size);
          }
      }
<span class="preprocessor">  #endif</span>
<span class="preprocessor"></span>      <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *)malloc(size);
  }
</pre></div><br/>
<br/>
 Note that the macro <code>BDE_BUILD_TARGET_EXC</code> is defined at compile-time to indicate whether exceptions are enabled. In the above code, if exceptions are not enabled, the code that throws <code><a class="el" href="classbslma_1_1TestAllocatorException.html">bslma::TestAllocatorException</a></code> is never executed. The following is the test driver for <code>my_ShortArray</code>. </dd></dl>
<dl class="user"><dt><b></b></dt><dd>Note that "\$" must be replaced by "\" in the preprocessor macro definitions that follow. The "$" symbols are present in this header file to avoid a diagnostic elicited by some compilers (e.g., "warning: multi-line comment"). <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="comment">// my_shortarray.t.cpp</span>
<span class="preprocessor">  #include &lt;my_shortarray.h&gt;</span>
<span class="preprocessor">  #include &lt;my_testallocator.h&gt;</span>
<span class="preprocessor">  #include &lt;<a class="code" href="bslma__testallocatorexception_8h.html" title="Provide an exception class for memory allocation operations.">bslma_testallocatorexception.h</a>&gt;</span>

  <span class="comment">// ...</span>

<span class="preprocessor">  #ifdef BDE_BUILD_TARGET_EXC</span>
<span class="preprocessor"></span><span class="preprocessor">  #define BSLMA_TESTALLOCATOR_EXCEPTION_TEST_BEGIN {                       \$</span>
<span class="preprocessor"></span>  {                                                                        \$
      <span class="keyword">static</span> <span class="keywordtype">int</span> firstTime = 1;                                            \$
      <span class="keywordflow">if</span> (veryVerbose &amp;&amp; firstTime) std::cout &lt;&lt;                           \$
          <span class="stringliteral">&quot;### BSLMA EXCEPTION TEST -- (ENABLED) --&quot;</span> &lt;&lt; std::endl;         \$
      firstTime = 0;                                                       \$
  }                                                                        \$
  <span class="keywordflow">if</span> (veryVeryVerbose) std::cout &lt;&lt;                                        \$
      <span class="stringliteral">&quot;### Begin bslma exception test.&quot;</span> &lt;&lt; std::endl;                      \$
  <span class="keywordtype">int</span> bslmaExceptionCounter = 0;                                           \$
  <span class="keyword">static</span> <span class="keywordtype">int</span> bslmaExceptionLimit = 100;                                    \$
  testAllocator.setAllocationLimit(bslmaExceptionCounter);                 \$
  <span class="keywordflow">do</span> {                                                                     \$
      <span class="keywordflow">try</span> {

<span class="preprocessor">  #define BSLMA_TESTALLOCATOR_EXCEPTION_TEST_END                           \$</span>
<span class="preprocessor"></span>      } <span class="keywordflow">catch</span> (<a class="code" href="classbslma_1_1TestAllocatorException.html">bslma::TestAllocatorException</a>&amp; e) {                         \$
          <span class="keywordflow">if</span> (veryVerbose &amp;&amp; bslmaExceptionLimit || veryVeryVerbose) {     \$
              --bslmaExceptionLimit;                                       \$
              std::cout &lt;&lt; <span class="stringliteral">&quot;(*** &quot;</span> &lt;&lt; bslmaExceptionCounter &lt;&lt; <span class="charliteral">&#39;)&#39;</span>;        \$
              <span class="keywordflow">if</span> (veryVeryVerbose) { std::cout &lt;&lt; <span class="stringliteral">&quot; BSLMA_EXCEPTION: &quot;</span>     \$
                  &lt;&lt; <span class="stringliteral">&quot;alloc limit = &quot;</span> &lt;&lt; bslmaExceptionCounter &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>     \$
                  &lt;&lt; <span class="stringliteral">&quot;last alloc size = &quot;</span> &lt;&lt; e.<a class="code" href="classbslma_1_1TestAllocatorException.html#a0217e2f894b1890ce94341f6003d3849">numBytes</a>();                 \$
              }                                                            \$
              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == bslmaExceptionLimit) {                         \$
                  std::cout &lt;&lt; <span class="stringliteral">&quot; [ Note: &#39;bslmaExceptionLimit&#39; reached. ]&quot;</span>;\$
              }                                                            \$
              std::cout &lt;&lt; std::endl;                                      \$
          }                                                                \$
          testAllocator.setAllocationLimit(++bslmaExceptionCounter);       \$
          <span class="keywordflow">continue</span>;                                                        \$
      }                                                                    \$
      testAllocator.setAllocationLimit(-1);                                \$
      <span class="keywordflow">break</span>;                                                               \$
  } <span class="keywordflow">while</span> (1);                                                             \$
  <span class="keywordflow">if</span> (veryVeryVerbose) std::cout &lt;&lt;                                        \$
      <span class="stringliteral">&quot;### End bslma exception test.&quot;</span> &lt;&lt; std::endl;                        \$
  }
<span class="preprocessor">  #else</span>
<span class="preprocessor"></span><span class="preprocessor">  #define BSLMA_TESTALLOCATOR_EXCEPTION_TEST_BEGIN                         \$</span>
<span class="preprocessor"></span>  {                                                                        \$
      <span class="keyword">static</span> <span class="keywordtype">int</span> firstTime = 1;                                            \$
      <span class="keywordflow">if</span> (verbose &amp;&amp; firstTime) { std::cout &lt;&lt;                             \$
          <span class="stringliteral">&quot;### BSLMA EXCEPTION TEST -- (NOT ENABLED) --&quot;</span> &lt;&lt; std::endl;     \$
          firstTime = 0;                                                   \$
      }                                                                    \$
  }
<span class="preprocessor">  #define BSLMA_TESTALLOCATOR_EXCEPTION_TEST_END</span>
<span class="preprocessor"></span><span class="preprocessor">  #endif</span>
<span class="preprocessor"></span>
  <span class="comment">// ...</span>

  <span class="keyword">static</span>
  <span class="keywordtype">bool</span> areEqual(<span class="keyword">const</span> <span class="keywordtype">short</span> *array1, <span class="keyword">const</span> <span class="keywordtype">short</span> *array2, <span class="keywordtype">int</span> numElement)
      <span class="comment">// Return &#39;true&#39; if the specified initial &#39;numElement&#39; in the specified</span>
      <span class="comment">// &#39;array1&#39; and &#39;array2&#39; have the same values, and &#39;false&#39; otherwise.</span>
  {
      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numElement; ++i) {
          <span class="keywordflow">if</span> (array1[i] != array2[i]) <span class="keywordflow">return</span> <span class="keyword">false</span>;
      }
      <span class="keywordflow">return</span> <span class="keyword">true</span>;
  }

  <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {
      <span class="keywordtype">int</span> test = argc &gt; 1 ? atoi(argv[1]) : 0;
      <span class="keywordtype">int</span> verbose = argc &gt; 2;
      <span class="keywordtype">int</span> veryVerbose = argc &gt; 3;
      <span class="keywordtype">int</span> veryVeryVerbose = argc &gt; 4;

      my_Allocator testAllocator;

      <span class="keywordflow">switch</span> (test) { <span class="keywordflow">case</span> 0:

        <span class="comment">// ...</span>

        <span class="keywordflow">case</span> 6: {
          <span class="keyword">struct </span>{
              <span class="keywordtype">int</span> d_line;
              <span class="keywordtype">int</span> d_numElem;
              <span class="keywordtype">short</span> d_exp[NUM_VALUES];
          } DATA[] = {
              { L_, 0, {} },
              { L_, 1, { V0 } },
              { L_, 5, { V0, V1, V2, V3, V4 } }
          };

          <span class="keyword">const</span> <span class="keywordtype">int</span> NUM_TEST = <span class="keyword">sizeof</span> DATA / <span class="keyword">sizeof</span> *DATA;

          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ti = 0; ti &lt; NUM_TEST; ++ti) {
              <span class="keyword">const</span> <span class="keywordtype">int</span>    LINE     = DATA[ti].d_line;
              <span class="keyword">const</span> <span class="keywordtype">int</span>    NUM_ELEM = DATA[ti].d_numElem;
              <span class="keyword">const</span> <span class="keywordtype">short</span> *EXP      = DATA[ti].d_exp;

              <a class="code" href="group__bslma__testallocator.html#ga54aebaa251b957630708f5f491fcadd3">BSLMA_TESTALLOCATOR_EXCEPTION_TEST_BEGIN</a> {
                  my_ShortArray mA(&amp;testAllocator);
                  <span class="keyword">const</span> my_ShortArray&amp; <a class="code" href="bdlf__bind__test_8h.html#a2487e64b489c5eaa866ce223b64a6713">A</a> = mA;
                  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ei = 0; ei &lt; NUM_ELEM; ++ei) {
                      mA.append(VALUES[ei]);
                  }
                  <span class="keywordflow">if</span> (veryVerbose) { P_(ti); P_(NUM_ELEM); <a class="code" href="bdlf__bind__test_8h.html#a6dce1d51457f0415ec5302d3c05cded5">P</a>(A); }
                  LOOP2_ASSERT(LINE, ti, areEqual(EXP, A, NUM_ELEM));
              } <a class="code" href="group__bslma__testallocator.html#ga59220055a07373b5ed62d98ec6206523">BSLMA_TESTALLOCATOR_EXCEPTION_TEST_END</a>
          }

          <span class="keywordflow">if</span> (veryVerbose) std::cout &lt;&lt; testAllocator &lt;&lt; std::endl;
        } <span class="keywordflow">break</span>;

        <span class="comment">// ...</span>

      }

      <span class="comment">// ...</span>
  }
</pre></div><br/>
<br/>
 </dd></dl>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Apr 1 2016 16:48:59 for BDE Release 3.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
