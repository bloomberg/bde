<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>BDE 3.0: bslh_spookyhashalgorithmimp Component</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <style>
      div.hanging {
        padding-left: 0.75in;
        text-indent: -0.50in;
      }
      div.unhanging {
        text-indent:     0in;
      }
      a.glossary {
        font-weight: bold;
        font-style: italic;
      }
    </style>
</head>
<!--
<body onload='searchBox.OnSelectItem(0);'>
-->
<body>

<table border=2 cellspacing=0 cellpadding=0 align=center>
<tr>
 <td valign=top align=center>
 <p align=center><b><i>Quick Links:</i></b></p>
 </td>
 <td valign=top align=center>
 <p align=center>
<a class="qindex" href="group__bal.html" target="_blank">bal</a> | <a class="qindex" href="group__bbl.html" target="_blank">bbl</a> | <a class="qindex" href="group__bdl.html" target="_blank">bdl</a> | <a class="qindex" href="group__bsl.html" target="_blank">bsl</a> | <a class="qindex" href="group__btl.html" target="_blank">btl</a>
 </td>
 </tr>
 </table>

  </div>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="components.html"><span>Components</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#namespaces">Namespaces</a>  </div>
  <div class="headertitle">
<h1>Component bslh_spookyhashalgorithmimp<br/>
<small>
[<a class="el" href="group__bslh.html">Package bslh</a>]</small>
</h1>  </div>
</div>
<div class="contents">

<p>Provide BDE style encapsulation of 3rd party SpookyHash code.  
<a href="#_details">More...</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacebslh.html">bslh</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<dl class="user"><dt><b>Outline</b></dt><dd><ul>
<li>
<a href="#1">Purpose</a> </li>
<li>
<a href="#2">Classes</a> </li>
<li>
<a href="#3">Description</a> <ul>
<li>
<a href="#3.1">Usage</a> <ul>
<li>
<a href="#3.1.1">Example: Creating 128-bit checksums</a> </li>
</ul>
</li>
<li>
<a href="#3.2">Changes</a> </li>
<li>
<a href="#3.3">Third-Party Documentation</a> </li>
</ul>
</li>
</ul>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="purpose"></a> <a class="anchor" id="1"></a> </dd></dl>
<dl class="user"><dt><b>Purpose: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>Provide BDE style encapsulation of 3rd party SpookyHash code. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="classes"></a> <a class="anchor" id="2"></a> </dd></dl>
<dl class="user"><dt><b>Classes: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><table class="doxtable">
<tr>
<td><a class="el" href="classbslh_1_1SpookyHashAlgorithmImp.html">bslh::SpookyHashAlgorithmImp</a> </td><td>encapsulation of 3rd party SpookyHash code  </td></tr>
</table>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="group__bslh__hash.html" title="Provide a struct to run bslh hash algorithms on supported types.">Component bslh_hash</a>, <a class="el" href="group__bslh__spookyhashalgorithm.html" title="Provide an implementation of the SpookyHash algorithm.">Component bslh_spookyhashalgorithm</a> </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="description"></a> <a class="anchor" id="3"></a> </dd></dl>
<dl class="user"><dt><b>Description: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><code><a class="el" href="classbslh_1_1SpookyHashAlgorithmImp.html">bslh::SpookyHashAlgorithmImp</a></code> provides BDE style encapsulation around Bob Jenkins' canonical SpookyHash implementation. SpookyHash provides a way to hash contiguous data all at once, or discontiguous data in pieces. More information is available at: <a href="http://burtleburtle.net/bob/hash/spooky.html">http://burtleburtle.net/bob/hash/spooky.html</a> </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="usage"></a> <a class="anchor" id="description.usage"></a> <a class="anchor" id="3.1"></a> </dd></dl>
<dl class="user"><dt><b>Usage: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>This section illustrates intended usage of this component. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="example~3A_creating_128-bit_checksums"></a> <a class="anchor" id="usage.example~3A_creating_128-bit_checksums"></a> <a class="anchor" id="description.usage.example~3A_creating_128-bit_checksums"></a> <a class="anchor" id="example"></a> <a class="anchor" id="usage.example"></a> <a class="anchor" id="description.usage.example"></a> <a class="anchor" id="3.1.1"></a> </dd></dl>
<dl class="user"><dt><b>Example: Creating 128-bit checksums: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>Suppose we have a library of 4 billion pieces of data and we want to store checksums for this data. For a 64-bit hash, there is a 35% chance of two of these checksums colliding (according to the approximation found here: <a href="http://en.wikipedia.org/wiki/Birthday_problem">http://en.wikipedia.org/wiki/Birthday_problem</a>). We want to avoid checksum collision, so we will use the 128-bit hashing functionality provided by <code>SpookyHashAlgorithmImp</code>. </dd></dl>
<dl class="user"><dt><b></b></dt><dd>First, we will declare a class <code>CheckedData</code> which will store some data as well as the checksum associated with it. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="keyword">class </span>CheckedData {
      <span class="comment">// This class holds a pointer to data and provides a way of verifying</span>
      <span class="comment">// that the data has not changed.</span>

      <span class="comment">// TYPES</span>
      <span class="keyword">typedef</span> <a class="code" href="structbsls_1_1Types.html#a62cdf73ffc20667bc9de36b07c9c25f0">bsls::Types::Uint64</a> Uint64;

      <span class="comment">// DATA</span>
      <span class="keywordtype">size_t</span>      d_length;
      <span class="keyword">const</span> <span class="keywordtype">char</span> *d_data;
      Uint64      d_checksum1;
      Uint64      d_checksum2;

    <span class="keyword">public</span>:
      CheckedData(<span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> length);
          <span class="comment">// Creates an instance of this class having the specified &#39;length&#39;</span>
          <span class="comment">// bytes of &#39;data&#39;.  The behavior is undefined unless &#39;data&#39; is</span>
          <span class="comment">// initialized with at least &#39;length&#39; bytes, and remains valid for</span>
          <span class="comment">// the lifetime of this object.  Note that only a pointer to the</span>
          <span class="comment">// data will be maintained, it will not be copied.</span>

      <span class="keyword">const</span> <span class="keywordtype">char</span> *getData();
          <span class="comment">// Return a pointer to the data being tracked by this class.</span>

      <span class="keywordtype">bool</span> isDataValid();
          <span class="comment">// Return &#39;true&#39; if the data stored in this class matches the</span>
          <span class="comment">// stored checksum, and &#39;false&#39; otherwise.</span>
  };
</pre></div><br/>
<br/>
 Then, we define the <code>CheckedData</code> constructor. Here we will use <code>SpookyHashImp</code> to calculate a 128-bit checksum. <br/>
<br/>
<div class="fragment"><pre class="fragment">  CheckedData::CheckedData(<span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> length)
  : d_length(length)
  , d_data(data)
  , d_checksum1(0)
  , d_checksum2(0)
  {
      <a class="code" href="bsls__assert_8h.html#a1d80716f3bc5018941bcaf0856d93a1b">BSLS_ASSERT</a>(data);

      SpookyHashAlgorithmImp hashAlg(1, 2);

      hashAlg.hash128(d_data, d_length, &amp;d_checksum1, &amp;d_checksum2);
  }

  <span class="keyword">const</span> <span class="keywordtype">char</span> *CheckedData::getData() {
      <span class="keywordflow">return</span> d_data;
  }
</pre></div><br/>
<br/>
 Next, we define <code>isDataValid</code>. We will generate a checksum from the contained data and then compare it to the checksum we generated when the class was created. If the two hashes match, then we can be reasonably certain that the data is still in a valid state (the chance of an accidental collision is very low). If the checksums do not match, we know that the data has been corrupted. We will not be able to restore it, but we will know not to trust it. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="keywordtype">bool</span> CheckedData::isDataValid() {
      SpookyHashAlgorithmImp hashAlg(1, 2);
      Uint64 checksum1 = 0;
      Uint64 checksum2 = 0;

      hashAlg.hash128(d_data, d_length, &amp;checksum1, &amp;checksum2);

      <span class="keywordflow">return</span> (d_checksum1 == checksum1) &amp;&amp; (d_checksum2 == checksum2);
  }
</pre></div><br/>
<br/>
 Then, we store some data in our <code>CheckedData</code> class for safekeeping. <br/>
<br/>
<div class="fragment"><pre class="fragment">      <span class="keywordtype">char</span> data[] = <span class="stringliteral">&quot;To be, or not to be--that is the question:&quot;</span>
                    <span class="stringliteral">&quot;Whether &#39;tis nobler in the mind to suffer&quot;</span>
                    <span class="stringliteral">&quot;The slings and arrows of outrageous fortune&quot;</span>
                    <span class="stringliteral">&quot;Or to take arms against a sea of troubles&quot;</span>
                    <span class="stringliteral">&quot;And by opposing end them.  To die, to sleep--&quot;</span>
                    <span class="stringliteral">&quot;No more--and by a sleep to say we end&quot;</span>
                    <span class="stringliteral">&quot;The heartache, and the thousand natural shocks&quot;</span>
                    <span class="stringliteral">&quot;That flesh is heir to.  &#39;Tis a consummation&quot;</span>
                    <span class="stringliteral">&quot;Devoutly to be wished.  To die, to sleep--&quot;</span>
                    <span class="stringliteral">&quot;To sleep--perchance to dream: ay, there&#39;s the rub,&quot;</span>
                    <span class="stringliteral">&quot;For in that sleep of death what dreams may come&quot;</span>
                    <span class="stringliteral">&quot;When we have shuffled off this mortal coil,&quot;</span>
                    <span class="stringliteral">&quot;Must give us pause.  There&#39;s the respect&quot;</span>
                    <span class="stringliteral">&quot;That makes calamity of so long life.&quot;</span>
                    <span class="stringliteral">&quot;For who would bear the whips and scorns of time,&quot;</span>
                    <span class="stringliteral">&quot;Th&#39; oppressor&#39;s wrong, the proud man&#39;s contumely&quot;</span>
                    <span class="stringliteral">&quot;The pangs of despised love, the law&#39;s delay,&quot;</span>
                    <span class="stringliteral">&quot;The insolence of office, and the spurns&quot;</span>
                    <span class="stringliteral">&quot;That patient merit of th&#39; unworthy takes,&quot;</span>
                    <span class="stringliteral">&quot;When he himself might his quietus make&quot;</span>
                    <span class="stringliteral">&quot;With a bare bodkin? Who would fardels bear,&quot;</span>
                    <span class="stringliteral">&quot;To grunt and sweat under a weary life,&quot;</span>
                    <span class="stringliteral">&quot;But that the dread of something after death,&quot;</span>
                    <span class="stringliteral">&quot;The undiscovered country, from whose bourn&quot;</span>
                    <span class="stringliteral">&quot;No traveller returns, puzzles the will,&quot;</span>
                    <span class="stringliteral">&quot;And makes us rather bear those ills we have&quot;</span>
                    <span class="stringliteral">&quot;Than fly to others that we know not of?&quot;</span>
                    <span class="stringliteral">&quot;Thus conscience does make cowards of us all,&quot;</span>
                    <span class="stringliteral">&quot;And thus the native hue of resolution&quot;</span>
                    <span class="stringliteral">&quot;Is sicklied o&#39;er with the pale cast of thought,&quot;</span>
                    <span class="stringliteral">&quot;And enterprise of great pitch and moment&quot;</span>
                    <span class="stringliteral">&quot;With this regard their currents turn awry&quot;</span>
                    <span class="stringliteral">&quot;And lose the name of action. -- Soft you now,&quot;</span>
                    <span class="stringliteral">&quot;The fair Ophelia! -- Nymph, in thy orisons&quot;</span>
                    <span class="stringliteral">&quot;Be all my sins remembered.&quot;</span>;
      CheckedData checkedData(data, strlen(data));
</pre></div><br/>
<br/>
 Now, we check that the <code>CheckedData</code> recognizes that it is still valid. <br/>
<br/>
<div class="fragment"><pre class="fragment">      ASSERT(checkedData.isDataValid());
</pre></div><br/>
<br/>
 Finally, we tamper with the data and check that our <code>CheckedData</code> class can detect this. <br/>
<br/>
<div class="fragment"><pre class="fragment">      data[34] = <span class="charliteral">&#39;z&#39;</span>;
      ASSERT(!checkedData.isDataValid());
</pre></div><br/>
<br/>
 </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="changes"></a> <a class="anchor" id="description.changes"></a> <a class="anchor" id="3.2"></a> </dd></dl>
<dl class="user"><dt><b>Changes: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>The third party code begins with the "SpookyHash" header below, and continues until the <a class="el" href="namespaceBloombergLP.html">BloombergLP</a> copyright notice. Changes made to the original code include: </dd></dl>
<dl class="user"><dt><b></b></dt><dd><ol>
<li>
Added <code><a class="el" href="namespaceBloombergLP.html">BloombergLP</a></code> and <code>bslh</code> namespaces  </li>
<li>
Renamed <code>SpookyHash</code> to <code>SpookyHashAlgorithmImp</code>  </li>
<li>
Removed usage of <code>stdint.h</code> (which might not be available on all platforms) and updated associated <code>typedef</code>s  </li>
<li>
Added <code>include</code> guards  </li>
<li>
Made some methods private  </li>
<li>
Reformatted comments and added comments  </li>
<li>
Updated indenting to BDE style  </li>
<li>
Moved <code>typedef</code>s within class  </li>
<li>
Changed C-style casts to <code>static_cast</code>s  </li>
</ol>
<div class="hanging"> </div></dd></dl>
<dl class="user"><dt><b></b></dt><dd><div class="hanging"> 10 Reordered methods according to BDE style</div></dd></dl>
<dl class="user"><dt><b></b></dt><dd><div class="hanging"> 11 Added inline to <code>Hash32</code> and <code>Hash64</code></div></dd></dl>
<dl class="user"><dt><b></b></dt><dd><div class="hanging"> 12 Changed static constants to <code>enum</code>s to avoid storage overhead</div></dd></dl>
<dl class="user"><dt><b></b></dt><dd><div class="hanging"> 13 Added constructor in place of <code>init</code></div></dd></dl>
<dl class="user"><dt><b></b></dt><dd><div class="hanging"> 14 Made function names lower case (had to change <code>Final</code> to <code>finalize</code> and <code>Short</code> to <code>shortHash</code> to avoid using a keyword)</div></dd></dl>
<dl class="user"><dt><b></b></dt><dd><div class="hanging"> </div> </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="third-party_documentation"></a> <a class="anchor" id="description.third-party_documentation"></a> <a class="anchor" id="3.3"></a> </dd></dl>
<dl class="user"><dt><b>Third-Party Documentation: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><br/>
<br/>
<div class="fragment"><pre class="fragment"> SpookyHash: a 128-bit non cryptographic hash function

 By Bob Jenkins, <span class="keyword">public</span> domain
   Oct 31 2010: alpha, framework + SpookyHash::Mix appears right
   Oct 31 2011: alpha again, Mix only good to 2^^69 but rest appears right
   Dec 31 2011: beta, improved Mix, tested it <span class="keywordflow">for</span> 2-bit deltas
   Feb  2 2012: production, same bits as beta
   Feb  5 2012: adjusted definitions of uint* to be more portable
   Mar 30 2012: 3 bytes/cycle, not 4. Alpha was 4 but wasn<span class="stringliteral">&#39;t thorough enough.</span>
<span class="stringliteral">   August 5 2012: SpookyV2 (different results)</span>
<span class="stringliteral"></span>
<span class="stringliteral"> Up to 3 bytes/cycle for long messages.  Reasonably fast for short messages.</span>
<span class="stringliteral"> All 1 or 2 bit deltas achieve avalanche within 1% bias per output bit.</span>
<span class="stringliteral"></span>
<span class="stringliteral"> This was developed for and tested on 64-bit x86-compatible processors.  It</span>
<span class="stringliteral"> assumes the processor is little-endian.  There is a macro controlling</span>
<span class="stringliteral"> whether unaligned reads are allowed (by default they are).  This should be</span>
<span class="stringliteral"> an equally good hash on big-endian machines, but it will compute different</span>
<span class="stringliteral"> results on them than on little-endian machines.</span>
<span class="stringliteral"></span>
<span class="stringliteral"> Google&#39;</span>s CityHash has similar specs to SpookyHash, and CityHash is faster on
 <span class="keyword">new</span> Intel boxes.  MD4 and MD5 also have similar specs, but they are orders
 of magnitude slower.  CRCs are two or more times slower, but unlike
 SpookyHash, they have nice math <span class="keywordflow">for</span> combining the CRCs of pieces to form the
 CRCs of wholes.  There are also cryptographic hashes, but those are even
 slower than MD5.
</pre></div><br/>
<br/>
 </dd></dl>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Apr 1 2016 16:48:55 for BDE Release 3.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
