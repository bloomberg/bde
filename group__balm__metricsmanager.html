<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>BDE 3.0: balm_metricsmanager Component</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <style>
      div.hanging {
        padding-left: 0.75in;
        text-indent: -0.50in;
      }
      div.unhanging {
        text-indent:     0in;
      }
      a.glossary {
        font-weight: bold;
        font-style: italic;
      }
    </style>
</head>
<!--
<body onload='searchBox.OnSelectItem(0);'>
-->
<body>

<table border=2 cellspacing=0 cellpadding=0 align=center>
<tr>
 <td valign=top align=center>
 <p align=center><b><i>Quick Links:</i></b></p>
 </td>
 <td valign=top align=center>
 <p align=center>
<a class="qindex" href="group__bal.html" target="_blank">bal</a> | <a class="qindex" href="group__bbl.html" target="_blank">bbl</a> | <a class="qindex" href="group__bdl.html" target="_blank">bdl</a> | <a class="qindex" href="group__bsl.html" target="_blank">bsl</a> | <a class="qindex" href="group__btl.html" target="_blank">btl</a>
 </td>
 </tr>
 </table>

  </div>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="components.html"><span>Components</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#namespaces">Namespaces</a>  </div>
  <div class="headertitle">
<h1>Component balm_metricsmanager<br/>
<small>
[<a class="el" href="group__balm.html">Package balm</a>]</small>
</h1>  </div>
</div>
<div class="contents">

<p>Provide a manager for recording and publishing metric data.  
<a href="#_details">More...</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacebalm.html">balm</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<dl class="user"><dt><b>Outline</b></dt><dd><ul>
<li>
<a href="#1">Purpose</a> </li>
<li>
<a href="#2">Classes</a> </li>
<li>
<a href="#3">Description</a> <ul>
<li>
<a href="#3.1">Thread Safety</a> <ul>
<li>
<a href="#3.1.1">Registered Concrete <code>balm::Publisher</code> Implementations</a> </li>
<li>
<a href="#3.1.2">Registered <code>RecordsCollectionCallback</code> Implementations</a> </li>
</ul>
</li>
<li>
<a href="#3.2">Usage</a> <ul>
<li>
<a href="#3.2.1">Example 1: Initialize a <code>balm::MetricsManager</code></a> </li>
<li>
<a href="#3.2.2">Example 2: Recording Metric Values with <code>balm::Collector</code></a> </li>
<li>
<a href="#3.2.3">Example 3: Recording Metric Values with a Callback</a> </li>
<li>
<a href="#3.2.4">Example 4: Publishing a Metric</a> </li>
</ul>
</li>
</ul>
</li>
</ul>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="purpose"></a> <a class="anchor" id="1"></a> </dd></dl>
<dl class="user"><dt><b>Purpose: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>Provide a manager for recording and publishing metric data. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="classes"></a> <a class="anchor" id="2"></a> </dd></dl>
<dl class="user"><dt><b>Classes: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><table class="doxtable">
<tr>
<td><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a> </td><td>manager for recording and publishing metric data  </td></tr>
</table>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="group__balm__publisher.html" title="Provide a protocol to publish recorded metric values.">Component balm_publisher</a>, <a class="el" href="group__balm__collectorrepository.html" title="Provide a repository for collectors.">Component balm_collectorrepository</a>, <a class="el" href="group__balm__metricregistry.html" title="Provide a registry for metrics.">Component balm_metricregistry</a>, <a class="el" href="group__balm__metric.html" title="Provide helper classes for recording metric values.">Component balm_metric</a>, <a class="el" href="group__balm__defaultmetricsmanager.html" title="Provide for a default instance of the metrics manager.">Component balm_defaultmetricsmanager</a>, <a class="el" href="group__balm__publicationscheduler.html" title="Provide a scheduler for publishing metrics.">Component balm_publicationscheduler</a> </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="description"></a> <a class="anchor" id="3"></a> </dd></dl>
<dl class="user"><dt><b>Description: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>This component provides a <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code> class for managing the recording and publishing of metric data. The metrics manager retrieves <code>balm::MetricRecords</code> from both the collector repository it owns as well as any <code>RecordsCollectionCallbacks</code> registered with it. The metrics manager also provides methods to register <code><a class="el" href="classbalm_1_1Publisher.html">balm::Publisher</a></code> objects. The <code>publish</code> method collects metrics for a category (or set of categories) and then sends the collected metrics to the publishers associated with that category (or set of categories). </dd></dl>
<dl class="user"><dt><b></b></dt><dd>Note that a metric in this context is an event associated with a measured value. This component does <em>not</em> define what constitutes an event or what the associated value represents. A collected metric contains the count of event occurrences along with the total, minimum, and maximum aggregates of the measured values. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="thread_safety"></a> <a class="anchor" id="description.thread_safety"></a> <a class="anchor" id="3.1"></a> </dd></dl>
<dl class="user"><dt><b>Thread Safety: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code> is fully <em>thread-safe</em>, meaning that all non-creator operations on a given instance can be safely invoked simultaneously from multiple threads. To avoid synchronization problems with user functions invoked by <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code>, special consideration must be taken when implementing these functions as specified below. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="registered_concrete_balm~3A~3Apublisher_implementations"></a> <a class="anchor" id="thread_safety.registered_concrete_balm~3A~3Apublisher_implementations"></a> <a class="anchor" id="description.thread_safety.registered_concrete_balm~3A~3Apublisher_implementations"></a> <a class="anchor" id="registered_concrete_balm"></a> <a class="anchor" id="thread_safety.registered_concrete_balm"></a> <a class="anchor" id="description.thread_safety.registered_concrete_balm"></a> <a class="anchor" id="3.1.1"></a> </dd></dl>
<dl class="user"><dt><b>Registered Concrete balm::Publisher Implementations: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>Concrete implementations of the <code><a class="el" href="classbalm_1_1Publisher.html">balm::Publisher</a></code> protocol (pure abstract base-class) registered with a <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code> object must <em>not</em> call (either directly or indirectly) the <code>publish</code> method on the <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code> object with which they are registered. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="registered_recordscollectioncallback_implementations"></a> <a class="anchor" id="thread_safety.registered_recordscollectioncallback_implementations"></a> <a class="anchor" id="description.thread_safety.registered_recordscollectioncallback_implementations"></a> <a class="anchor" id="3.1.2"></a> </dd></dl>
<dl class="user"><dt><b>Registered RecordsCollectionCallback Implementations: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>Implementations of <code><a class="el" href="classbalm_1_1MetricsManager.html#aa6f62616139bc125d78173f11c2f5174">balm::MetricsManager::RecordsCollectionCallback</a></code> registered with a <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code> will be invoked by a function holding mutex locks that provide synchronized access to data in that <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code>. Therefore registered implementations of <code>RecordsCollectionCallback</code> must <em>not</em> make any re-entrant calls (either directly or indirectly) to member functions of the <code>balm::MetricManager</code> object with which they are registered. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="usage"></a> <a class="anchor" id="description.usage"></a> <a class="anchor" id="3.2"></a> </dd></dl>
<dl class="user"><dt><b>Usage: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>The following examples demonstrate how to configure, collect, and publish metrics. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="example_1~3A_initialize_a_balm~3A~3Ametricsmanager"></a> <a class="anchor" id="usage.example_1~3A_initialize_a_balm~3A~3Ametricsmanager"></a> <a class="anchor" id="description.usage.example_1~3A_initialize_a_balm~3A~3Ametricsmanager"></a> <a class="anchor" id="example_1"></a> <a class="anchor" id="usage.example_1"></a> <a class="anchor" id="description.usage.example_1"></a> <a class="anchor" id="3.2.1"></a> </dd></dl>
<dl class="user"><dt><b>Example 1: Initialize a balm::MetricsManager: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>This example demonstrates how to create and configure a <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code> that we will use to record and publish metric values. We first create a <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code> object and a <code>SimpleStreamPublisher</code> object. Note that <code>SimpleStreamPublisher</code> is an example implementation of the <code><a class="el" href="classbalm_1_1Publisher.html">balm::Publisher</a></code> protocol defined in the <code>balm_publisher</code> component. In practice, clients typically use a standard publisher class (e.g., <code><a class="el" href="classbalm_1_1StreamPublisher.html">balm::StreamPublisher</a></code>). <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {
  {

      <span class="comment">// ...</span>

      <a class="code" href="classbslma_1_1Allocator.html">bslma::Allocator</a>   *allocator = <a class="code" href="structbslma_1_1Default.html#a418cbb340801caa455fd33177d1ff8d5">bslma::Default::allocator</a>(0);
      <a class="code" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a> manager(allocator);

      <a class="code" href="classbsl_1_1shared__ptr.html">bsl::shared_ptr&lt;balm::Publisher&gt;</a> publisher(
                          <span class="keyword">new</span> (*allocator) SimpleStreamPublisher(bsl::cout),
                          allocator);
      manager.<a class="code" href="classbalm_1_1MetricsManager.html#a3ab6f3eec3141e6c3af9e1c702548348">addGeneralPublisher</a>(publisher);

      <span class="comment">// ...</span>
</pre></div><br/>
<br/>
 </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="example_2~3A_recording_metric_values_with_balm~3A~3Acollector"></a> <a class="anchor" id="usage.example_2~3A_recording_metric_values_with_balm~3A~3Acollector"></a> <a class="anchor" id="description.usage.example_2~3A_recording_metric_values_with_balm~3A~3Acollector"></a> <a class="anchor" id="example_2"></a> <a class="anchor" id="usage.example_2"></a> <a class="anchor" id="description.usage.example_2"></a> <a class="anchor" id="3.2.2"></a> </dd></dl>
<dl class="user"><dt><b>Example 2: Recording Metric Values with balm::Collector: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>This second example demonstrates using <code><a class="el" href="classbalm_1_1Collector.html">balm::Collector</a></code> objects (obtained from a metrics manager's collector repository) to collect metrics related to a hypothetical <code>EventHandler</code> class. On construction, the event handler obtains references to <code><a class="el" href="classbalm_1_1Collector.html">balm::Collector</a></code> objects from the metrics manager's collector repository. On each handled event, the <code>EventHandler</code>, updates its collectors with the appropriate metric values. </dd></dl>
<dl class="user"><dt><b></b></dt><dd>Note that the <code>balm_metric</code> component provides both classes and macros to reduce the code required for collecting metric values. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="keyword">class </span>EventHandler {
      <span class="comment">// Provide an example event-handling mechanism that records metrics</span>
      <span class="comment">// for (1) the size of the processed event messages and (2) the number</span>
      <span class="comment">// of failures, using &#39;balm::Collector&#39; objects provided by a</span>
      <span class="comment">// &#39;balm::MetricsManager&#39;.</span>

      <span class="comment">// PRIVATE DATA</span>
      <a class="code" href="classbalm_1_1Collector.html">balm::Collector</a> *d_eventMessageSizes_p;  <span class="comment">// collect the message sizes</span>

      <a class="code" href="classbalm_1_1Collector.html">balm::Collector</a> *d_eventFailures_p;      <span class="comment">// collect the number of</span>
                                               <span class="comment">// failures</span>

  <span class="comment">// ...</span>

    <span class="keyword">public</span>:
      <span class="comment">// CREATORS</span>
</pre></div><br/>
<br/>
 We obtain the addresses of the respective <code><a class="el" href="classbalm_1_1Collector.html">balm::Collector</a></code> objects that we will use to collect metrics values from the metrics managers' collector repository. Note that, in practice, clients can use the <code>balm::DefaultMetricManager</code> (see <code>balm_defaultmetricsmanager</code> and <code>balm_metric</code>) rather than explicitly pass the address of a metrics manager. <br/>
<br/>
<div class="fragment"><pre class="fragment">      EventHandler(<a class="code" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a> *manager)
      : d_eventMessageSizes_p(
             manager-&gt;collectorRepository().getDefaultCollector(
                                              <span class="stringliteral">&quot;MyCategory&quot;</span>, <span class="stringliteral">&quot;messageSizes&quot;</span>))
      , d_eventFailures_p(
             manager-&gt;collectorRepository().getDefaultCollector(
                                              <span class="stringliteral">&quot;MyCategory&quot;</span>, <span class="stringliteral">&quot;eventFailures&quot;</span>))
      {}

      <span class="comment">// MANIPULATORS</span>
</pre></div><br/>
<br/>
 Then, when processing an "event", we update the <code><a class="el" href="classbalm_1_1Collector.html">balm::Collector</a></code> objects with the appropriate metric values for the event. <br/>
<br/>
<div class="fragment"><pre class="fragment">      <span class="keywordtype">int</span> handleEvent(<span class="keywordtype">int</span> eventId, <span class="keyword">const</span> <a class="code" href="classbsl_1_1basic__string.html">bsl::string</a>&amp; eventMessage)
          <span class="comment">// Process the event described by the specified &#39;eventId&#39; and</span>
          <span class="comment">// &#39;eventMessage&#39; .  Return 0 on success, and a non-zero value</span>
          <span class="comment">// if there was an error handling the event.</span>
      {
         <span class="keywordtype">int</span> returnCode = 0;
         d_eventMessageSizes_p-&gt;update(eventMessage.<a class="code" href="group__bslstl__string.html#ga8b5592bfab066f30c8e3948106b8c9ad">size</a>());

  <span class="comment">// ...    (Process the event)</span>

         <span class="keywordflow">if</span> (0 != returnCode) {
             d_eventFailures_p-&gt;update(1);
         }
         <span class="keywordflow">return</span> returnCode;
      }

  <span class="comment">// ...</span>

  };
</pre></div><br/>
<br/>
 </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="example_3~3A_recording_metric_values_with_a_callback"></a> <a class="anchor" id="usage.example_3~3A_recording_metric_values_with_a_callback"></a> <a class="anchor" id="description.usage.example_3~3A_recording_metric_values_with_a_callback"></a> <a class="anchor" id="example_3"></a> <a class="anchor" id="usage.example_3"></a> <a class="anchor" id="description.usage.example_3"></a> <a class="anchor" id="3.2.3"></a> </dd></dl>
<dl class="user"><dt><b>Example 3: Recording Metric Values with a Callback: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>The metrics manager provides a facility to register a callback that will report metric values. A callback should be used if clients want to customize how a metric, or group of metrics, are recorded. In the following example, the <code>EventHandlerWithCallback</code> class maintains a metric for the average number of events per second that it reports through a <code>balm::MetricsManager::MetricsCollectionCallback</code>. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="comment">// eventhandlerwithcallback.h</span>

  <span class="keyword">class </span>EventHandlerWithCallback {
      <span class="comment">// Provide an example event handling mechanism that records a</span>
      <span class="comment">// metric for the number of events per second and reports that metric</span>
      <span class="comment">// using a &#39;balm::MetricsManager::RecordsCollectionCallback&#39;.</span>

      <span class="comment">// PRIVATE DATA</span>
      <a class="code" href="classbsls_1_1AtomicInt.html">bsls::AtomicInt</a>       d_numEvents;         <span class="comment">// number of events</span>

      <a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a>    d_periodStart;       <span class="comment">// start of the current</span>
                                                 <span class="comment">// period</span>

      <a class="code" href="classbalm_1_1MetricId.html">balm::MetricId</a>        d_eventsPerSecId;    <span class="comment">// identifies the events-</span>
                                                 <span class="comment">// per-second metric</span>
      <a class="code" href="classbalm_1_1MetricsManager.html#a1c53bc2263ad5db6fc7ad1a84c469eb3">balm::MetricsManager::CallbackHandle</a>
                            d_callbackHandle;    <span class="comment">// identifies the callback</span>

      <a class="code" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a> *d_metricsManager_p;  <span class="comment">// metrics manager (held,</span>
                                                 <span class="comment">// but not owned)</span>
   <span class="comment">// ...</span>

      <span class="comment">// PRIVATE MANIPULATORS</span>
      <span class="keywordtype">void</span> collectMetricsCb(<a class="code" href="classbsl_1_1vector.html">bsl::vector&lt;balm::MetricRecord&gt;</a> *records,
                            <span class="keywordtype">bool</span>                             resetFlag);
          <span class="comment">// Append to the specified &#39;records&#39; the aggregated values of the</span>
          <span class="comment">// metrics recorded by this event handler and, if &#39;resetFlag&#39; is</span>
          <span class="comment">// &#39;true&#39;, reset those metric values to their default state.  Note</span>
          <span class="comment">// that this method is intended to be used as a callback, and is</span>
          <span class="comment">// consistent with the</span>
          <span class="comment">// &#39;balm::MetricsManager::RecordsCollectionCallback&#39; function</span>
          <span class="comment">// prototype.</span>

    <span class="keyword">public</span>:
      <span class="comment">// CREATORS</span>
      EventHandlerWithCallback(<a class="code" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a> *manager,
                               <a class="code" href="classbslma_1_1Allocator.html">bslma::Allocator</a>    *basicAllocator = 0);
          <span class="comment">// Initialize this object to use the specified &#39;manager&#39; to record</span>
          <span class="comment">// and publish metrics.  Optionally specify a &#39;basicAllocator&#39;</span>
          <span class="comment">// used to supply memory.  If &#39;basicAllocator&#39; is 0, the currently</span>
          <span class="comment">// installed default allocator is used.</span>

      ~EventHandlerWithCallback();
          <span class="comment">// Destroy this event handler.</span>

      <span class="comment">// MANIPULATORS</span>
      <span class="keywordtype">int</span> handleEvent(<span class="keywordtype">int</span> eventId, <span class="keyword">const</span> <a class="code" href="classbsl_1_1basic__string.html">bsl::string</a>&amp; eventMessage);
          <span class="comment">// Process the event described by the specified &#39;eventId&#39; and</span>
          <span class="comment">// &#39;eventMessage&#39;.  Return 0 on success, and a non-zero value if</span>
          <span class="comment">// there was an error processing the event.</span>

  <span class="comment">// ...</span>

  };
</pre></div><br/>
<br/>
 In the implementation of <code>EventHandlerWithCallback</code> below, we ensure that the callback is registered on construction and removed before the object is destroyed. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="comment">// eventhandlerwithcallback.cpp</span>

  <span class="keyword">namespace </span>{

  <span class="keyword">const</span> <span class="keywordtype">char</span> *METRIC_CATEGORY = <span class="stringliteral">&quot;MyCategory&quot;</span>;

  }
</pre></div><br/>
<br/>
 The callback creates metric records and populates them with data collected by the event handler. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="comment">// PRIVATE MANIPULATORS</span>
  <span class="keywordtype">void</span> EventHandlerWithCallback::collectMetricsCb(
                                  <a class="code" href="classbsl_1_1vector.html">bsl::vector&lt;balm::MetricRecord&gt;</a> *records,
                                  <span class="keywordtype">bool</span>                             resetFlag)
  {
      <span class="keywordtype">int</span> numEvents = resetFlag ?
                      (int)d_numEvents.swap(0) :
                      (int)d_numEvents;
      <a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a> now         = <a class="code" href="structbdlt_1_1CurrentTime.html#af4a53b1fb4f2fdfa249d57980e6d02de">bdlt::CurrentTime::now</a>();
      <a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a> elapsedTime = now - d_periodStart;
      d_periodStart = now;

      <a class="code" href="classbalm_1_1MetricRecord.html">balm::MetricRecord</a> record(d_eventsPerSecId);
      record.<a class="code" href="classbalm_1_1MetricRecord.html#affaaf4cd704d5e55e64a9d7a1e18c33f">count</a>() = 1;
      record.<a class="code" href="classbalm_1_1MetricRecord.html#ae5464855ed8e7c376a0e620efeb43cf1">total</a>() = numEvents / elapsedTime.<a class="code" href="classbsls_1_1TimeInterval.html#a649cad30ff67b82ca51f650254218ece">totalSecondsAsDouble</a>();

      records-&gt;<a class="code" href="group__bslstl__vector.html#gaa1d6a35af66d87307ee9a48be96644a5">push_back</a>(record);
  }
</pre></div><br/>
<br/>
 In the constructor, we initialize a metric id from the specified <code>manager</code> object's metric registry. We will also register the collection callback (<code>collectMetricsCb</code>) with the supplied <code>manager</code>. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="comment">// CREATORS</span>
  EventHandlerWithCallback::EventHandlerWithCallback(
                                        <a class="code" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a> *manager,
                                        <a class="code" href="classbslma_1_1Allocator.html">bslma::Allocator</a>     *basicAllocator)
  : d_numEvents(0)
  , d_periodStart(bdlt::CurrentTime::now())
  , d_eventsPerSecId()
  , d_callbackHandle(balm::MetricsManager::e_INVALID_HANDLE)
  , d_metricsManager_p(manager)
  {
      d_eventsPerSecId = d_metricsManager_p-&gt;metricRegistry().getId(
                                        METRIC_CATEGORY, <span class="stringliteral">&quot;eventsPerSecond&quot;</span>);
</pre></div><br/>
<br/>
 We now register the callback function <code>collectMetricsCb</code> with the metrics manager. We use <code><a class="el" href="structbdlf_1_1BindUtil.html">bdlf::BindUtil</a></code> to bind the member function to a <code>bsl::function</code> matching the <code><a class="el" href="classbalm_1_1MetricsManager.html#aa6f62616139bc125d78173f11c2f5174">balm::MetricsManager::RecordsCollectionCallback</a></code> function prototype. The private data member <code>d_callbackHandle</code> is used to store the <code><a class="el" href="classbalm_1_1MetricsManager.html#a1c53bc2263ad5db6fc7ad1a84c469eb3">balm::MetricsManager::CallbackHandle</a></code> returned for the registered callback; we will use this handle later to remove the callback from the metrics manager. <br/>
<br/>
<div class="fragment"><pre class="fragment">      d_callbackHandle =
         d_metricsManager_p-&gt;registerCollectionCallback(
            METRIC_CATEGORY,
            bdlf::BindUtil::bindA(basicAllocator,
                                 &amp;EventHandlerWithCallback::collectMetricsCb,
                                 <span class="keyword">this</span>,
                                 <a class="code" href="namespacebdlf_1_1PlaceHolders.html#a15d6194465744f5f4a1c9f98ca44ebca">bdlf::PlaceHolders::_1</a>,
                                 <a class="code" href="namespacebdlf_1_1PlaceHolders.html#a1b20b113c529e7825ad00bb527fcc6ad">bdlf::PlaceHolders::_2</a>));
  }
</pre></div><br/>
<br/>
 In the destructor we use the <code><a class="el" href="classbalm_1_1MetricsManager.html#a1c53bc2263ad5db6fc7ad1a84c469eb3">balm::MetricsManager::CallbackHandle</a></code>, stored in <code>d_callbackHandle</code>, to remove the callback from the metrics manager. This prevents the metrics manager from invoking the callback method on an object that has already been destroyed. <br/>
<br/>
<div class="fragment"><pre class="fragment">  EventHandlerWithCallback::~EventHandlerWithCallback()
  {
      <span class="keywordtype">int</span> rc =
             d_metricsManager_p-&gt;removeCollectionCallback(d_callbackHandle);
      assert(0 == rc);
  }

  <span class="comment">// MANIPULATORS</span>
  <span class="keywordtype">int</span> EventHandlerWithCallback::handleEvent(<span class="keywordtype">int</span>                eventId,
                                            <span class="keyword">const</span> <a class="code" href="classbsl_1_1basic__string.html">bsl::string</a>&amp; eventMessage)
  {
</pre></div><br/>
<br/>
 We increment the atomic integer <code>d_numEvents</code> to keep track of the number events handled by the <code>handleEvent</code> method. If collecting a metric is expensive (e.g., metrics requiring a system call to collect), clients should test whether the metric is enabled before performing the collection operation. <br/>
<br/>
<div class="fragment"><pre class="fragment">      <span class="comment">// We don&#39;t test &#39;d_eventsPerSecId.category()-&gt;enabled())&#39; before</span>
      <span class="comment">// incrementing &#39;d_numEvents&#39; because, in this instance, it will not</span>
      <span class="comment">// improve performance.</span>
      ++d_numEvents;

  <span class="comment">// ...    (Process the event)</span>

      <span class="keywordflow">return</span> 0;
   }

  <span class="comment">// ...</span>
</pre></div><br/>
<br/>
 </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="example_4~3A_publishing_a_metric"></a> <a class="anchor" id="usage.example_4~3A_publishing_a_metric"></a> <a class="anchor" id="description.usage.example_4~3A_publishing_a_metric"></a> <a class="anchor" id="example_4"></a> <a class="anchor" id="usage.example_4"></a> <a class="anchor" id="description.usage.example_4"></a> <a class="anchor" id="3.2.4"></a> </dd></dl>
<dl class="user"><dt><b>Example 4: Publishing a Metric: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>The metrics manager provides a <code>publish</code> operation to publish metrics for a category or set of categories. In this example we will use the metrics manager's <code>publishAll</code> operation to publish all the metrics managed by the metrics manager. We will record metrics for "MyCategory" using instances of the <code>EventHandler</code> and <code>EventHandlerWithCallback</code> classes (defined above). This example assumes that an instance, <code>manager</code>, of the <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code> class has been initialized as in example 1. Note that, in practice the publish operation is normally tied to a scheduling mechanism (e.g., see <code>balm_publicationscheduler</code>). <br/>
<br/>
<div class="fragment"><pre class="fragment">  EventHandler             eventHandler(&amp;manager);
  EventHandlerWithCallback eventHandlerWithCallback(&amp;manager);

  eventHandler.handleEvent(0, <span class="stringliteral">&quot;A 28 character event message&quot;</span>);
  eventHandlerWithCallback.handleEvent(1, <span class="stringliteral">&quot;A different event message&quot;</span>);
  manager.<a class="code" href="classbalm_1_1MetricsManager.html#a94c51743de384bdc0402fd555dbf914c">publishAll</a>();

  eventHandler.handleEvent(0, <span class="stringliteral">&quot;A 28 character event message&quot;</span>);
  eventHandler.handleEvent(0, <span class="stringliteral">&quot;A 28 character event message&quot;</span>);
  eventHandlerWithCallback.handleEvent(1, <span class="stringliteral">&quot;A different event message&quot;</span>);
  manager.<a class="code" href="classbalm_1_1MetricsManager.html#a94c51743de384bdc0402fd555dbf914c">publishAll</a>();
</pre></div><br/>
<br/>
 Executing the example should result in two samples being published to standard output. Each sample should contain 3 metrics belonging to the metric category "MyCategory". The metric "eventsPerSecond" is collected by the <code>EventHandlerWithCallback</code>, while "messageSizes", and "eventFailures" (both collected by <code>EventHandler</code>). <br/>
<br/>
<div class="fragment"><pre class="fragment"> 09FEB2009_18:52:51.093+0000 3 Records
         Elapsed <a class="code" href="namespacebdet.html#aac65e816e68f5285b127a9071544c5c1">Time</a>: 0.001358s
         MyCategory.eventsPerSecond [count = 1, total = 2267.57, ... ]
         MyCategory.messageSizes [count = 1, total = 28, min = 28, max = 28]
         MyCategory.eventFailures [count = 0, total = 0, ... ]
 09FEB2009_18:52:51.096+0000 3 Records
         Elapsed <a class="code" href="namespacebdet.html#aac65e816e68f5285b127a9071544c5c1">Time</a>: 0.002217s
         MyCategory.eventsPerSecond [count = 1, total = 453.721, ... ]
         MyCategory.messageSizes [count = 2, total = 56, min = 28, max = 28]
         MyCategory.eventFailures [count = 0, total = 0, ... ]
</pre></div><br/>
<br/>
 </dd></dl>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Apr 1 2016 16:48:28 for BDE Release 3.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
