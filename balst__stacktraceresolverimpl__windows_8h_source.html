<!doctype HTML public "-//W3C//DTD HTML 4.0 Frameset//EN">
<html>
<title>BDE 3.0</title>
<html>
<pre>
// balst_stacktraceresolverimpl_windows.h                             -*-C++-*-

// ----------------------------------------------------------------------------
//                                   NOTICE
//
// This component is not up to date with current BDE coding standards, and
// should not be used as an example for new development.
// ----------------------------------------------------------------------------

#ifndef INCLUDED_BALST_STACKTRACERESOLVERIMPL_WINDOWS
#define INCLUDED_BALST_STACKTRACERESOLVERIMPL_WINDOWS

#ifndef INCLUDED_BSLS_IDENT
#include &lt;bsls_ident.h&gt;
#endif
BSLS_IDENT(&quot;$Id: $&quot;)

//@PURPOSE: Provide resolution of symbols in stack trace for Windows objects.
//
//@CLASSES:
//   balst::StackTraceResolverImpl&lt;Windows&gt;: symbol resolution for Windows objs
//
//@SEE_ALSO:
//
//@DESCRIPTION: This class provides a class this able to take a vector of
// &#39;balst::StackTraceFrame&#39;s that have only their &#39;address&#39; fields set, and
// sets as many of the other fields in the stack trace frames as possible.  Elf
// objects are used on Solaris, Linux, and HPUX platforms.
//
///Usage
///-----
// This component is an implementation detail of &#39;balst&#39; and is *not* intended
// for direct client use.  It is subject to change without notice.  As such, a
// usage example is not provided.

#ifndef INCLUDED_BALSCM_VERSION
#include &lt;balscm_version.h&gt;
#endif

#ifndef INCLUDED_BALST_OBJECTFILEFORMAT
#include &lt;balst_objectfileformat.h&gt;
#endif

#ifndef INCLUDED_BALST_STACKTRACE
#include &lt;balst_stacktrace.h&gt;
#endif

#ifndef INCLUDED_BALST_STACKTRACEFRAME
#include &lt;balst_stacktraceframe.h&gt;
#endif

#ifndef INCLUDED_BSL_VECTOR
#include &lt;bsl_vector.h&gt;
#endif

#ifndef INCLUDED_BSLMA_ALLOCATOR
#include &lt;bslma_allocator.h&gt;
#endif

namespace BloombergLP {

#if defined(BALST_OBJECTFILEFORMAT_RESOLVER_WINDOWS)


namespace balst {

template &lt;typename RESOLVER_POLICY&gt;
class StackTraceResolverImpl;

          // =======================================================
          // class StackTraceResolverImpl&lt;ObjectFileFormat::Windows&gt;
          // =======================================================

template &lt;&gt;
class StackTraceResolverImpl&lt;ObjectFileFormat::Windows&gt; {
    // This type is for resolving symbols in Windows executables.  Resolving
    // symbols on Windows is straightforward using the dbghelp.dll library,
    // described at
    // http://msdn.microsoft.com/en-us/library/ms681412(v=VS.85).aspx

  private:
    // NOT IMPLEMENTED
    StackTraceResolverImpl();
    StackTraceResolverImpl(const StackTraceResolverImpl&amp;);
    StackTraceResolverImpl&amp; operator=(
                                          const StackTraceResolverImpl&amp;);
    ~StackTraceResolverImpl();

  public:
    // CLASS METHODS
    static int resolve(StackTrace *stackTrace,
                       bool              demangle);
        // Given a specified stack trace object &#39;stackTrace&#39; of stack trace
        // frames with only their &#39;address&#39; fields valid, set as many other
        // fields of the frames as possible.  The &#39;demangle&#39; argument is
        // ignored, demangling always happens on Windows.  Return 0 if
        // successful and a non-zero value otherwise.

    static inline
    int testFunc();
        // For testing only.  Do some random garbage and return a line number
        // from within the routine.
};

                        // ----------------------------
                        // class StackTraceResolverImpl
                        // ----------------------------

inline
int StackTraceResolverImpl&lt;ObjectFileFormat::Windows&gt;::testFunc()
{
    // Do some random garbage to generate some code, then return a line number
    // within this routine

    int line = 0, lineCopy = 0;

    for (int i = 0; true; ++i) {
        BSLS_ASSERT_OPT(line == lineCopy);

        const int loopGuard = 0x8edf0000;    // garbage with a lot of trailing
                                             // 0&#39;s.
        const int mask      = 0xa72c3dca;    // pure garbage

        enum { k_LINE = __LINE__ };

        for (int i = 0; !(i &amp; loopGuard); ++i) {
            line ^= (i &amp; mask);
        }

        // The above loop will leave the value of &#39;line&#39; unchanged.  See
        // &#39;foilOptimizer&#39; in the test driver.

        BSLS_ASSERT_OPT(line == lineCopy);

        if (line != 0) {
            break;
        }

        line = k_LINE;
        lineCopy = line;
    }

    return line;
}

}  // close package namespace

#endif

}  // close enterprise namespace

#endif

// ----------------------------------------------------------------------------
// Copyright 2015 Bloomberg Finance L.P.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// ----------------------------- END-OF-FILE ----------------------------------
</pre>
</body>
</html>
