<!doctype HTML public "-//W3C//DTD HTML 4.0 Frameset//EN">
<html>
<title>BDE 3.0</title>
<html>
<pre>
// ball_scopedattribute.h                                             -*-C++-*-

// ----------------------------------------------------------------------------
//                                   NOTICE
//
// This component is not up to date with current BDE coding standards, and
// should not be used as an example for new development.
// ----------------------------------------------------------------------------

#ifndef INCLUDED_BALL_SCOPEDATTRIBUTE
#define INCLUDED_BALL_SCOPEDATTRIBUTE

//@PURPOSE: Provide a scoped guard for a single BALL attribute.
//
//@CLASSES:
//  ball::ScopedAttribute: single attribute scoped guard
//
//@SEE_ALSO: ball_attribute
//
//@DESCRIPTION: This component defines a type, &#39;ball::ScopedAttribute&#39;, that
// serves as a scoped guard for &#39;ball::Attribute&#39; objects.  It defines a single
// attribute for the current thread while it is in scope.
//
///Usage
///-----
// Suppose that service requests for a fictional service with id &#39;999&#39; are
// handled asynchronously by the function below.  Creating an instance of this
// class will set BALL attributes for any logging performed while the request
// is being processed:
//..
//  void handleServiceRequest(const Request&amp; request)
//  {
//     BALL_LOG_SET_CATEGORY(&quot;MY.SERVICE&quot;);
//
//     ball::ScopedAttribute attribute(&quot;request&quot;, request.selectionName());
//
//     BALL_LOG_TRACE &lt;&lt; &quot;Handling request: &quot; &lt;&lt; request &lt;&lt; BALL_LOG_END;
//
//     // handle request here
//  }
//..
// Attribute &quot;request&quot; will be set in the calling thread and will affect
// publication of any BALL messages for the lifetime of &#39;attribute&#39;.

#ifndef INCLUDED_BALSCM_VERSION
#include &lt;balscm_version.h&gt;
#endif

#ifndef INCLUDED_BALL_ATTRIBUTE
#include &lt;ball_attribute.h&gt;
#endif

#ifndef INCLUDED_BALL_ATTRIBUTECONTAINER
#include &lt;ball_attributecontainer.h&gt;
#endif

#ifndef INCLUDED_BALL_ATTRIBUTECONTAINERLIST
#include &lt;ball_attributecontainerlist.h&gt;
#endif

#ifndef INCLUDED_BALL_ATTRIBUTECONTEXT
#include &lt;ball_attributecontext.h&gt;
#endif

#ifndef INCLUDED_BSLMA_ALLOCATOR
#include &lt;bslma_allocator.h&gt;
#endif

#ifndef INCLUDED_BSLS_TYPES
#include &lt;bsls_types.h&gt;
#endif

#ifndef INCLUDED_BSL_IOSFWD
#include &lt;bsl_iosfwd.h&gt;
#endif

#ifndef INCLUDED_BSL_STRING
#include &lt;bsl_string.h&gt;
#endif

namespace BloombergLP {

namespace ball {
                    // ===============================
                    // class ScopedAttribute_Container
                    // ===============================

class ScopedAttribute_Container : public AttributeContainer {
    // This component-private class is a concrete implementation of the
    // &#39;AttributeContainer&#39; protocol for a single attribute.

    // DATA
    Attribute d_attribute;

    // NOT IMPLEMENTED
    ScopedAttribute_Container(const ScopedAttribute_Container&amp;);
    ScopedAttribute_Container&amp; operator=(const ScopedAttribute_Container&amp;);

  public:
    // CREATORS
    ScopedAttribute_Container(const char         *name,
                              const bsl::string&amp;  value,
                              bslma::Allocator   *basicAllocator = 0);
    ScopedAttribute_Container(const char         *name,
                              int                 value,
                              bslma::Allocator   *basicAllocator = 0);
    ScopedAttribute_Container(const char         *name,
                              bsls::Types::Int64  value,
                              bslma::Allocator   *basicAllocator = 0);
        // Create a BALL attribute container holding a single rule, associating
        // the specified &#39;name&#39; with the specified &#39;value&#39;.  Optionally specify
        // a &#39;basicAllocator&#39; used to supply memory.  If &#39;basicAllocator&#39; is 0
        // or unspecified, the currently installed default allocator is used.


    virtual ~ScopedAttribute_Container();
        // Destroy this object;

    // ACCESSORS
    virtual bool hasValue(const Attribute&amp; value) const;
        // Return &#39;true&#39; if the specified &#39;value&#39; is the same as the value held
        // in this container, and &#39;false&#39; otherwise.

    virtual bsl::ostream&amp; print(bsl::ostream&amp; stream,
                                int           level = 0,
                                int           spacesPerLevel = 4) const;
        // Format this object to the specified output &#39;stream&#39; at the (absolute
        // value of) the optionally specified indentation &#39;level&#39; and return a
        // reference to &#39;stream&#39;.  If &#39;level&#39; is specified, optionally specify
        // &#39;spacesPerLevel&#39;, the number of spaces per indentation level for
        // this and all of its nested objects.  If &#39;level&#39; is negative,
        // suppress indentation of the first line.  If &#39;spacesPerLevel&#39; is
        // negative, format the entire output on one line, suppressing all but
        // the initial indentation (as governed by &#39;level&#39;).  If &#39;stream&#39; is
        // not valid on entry, this operation has no effect.
};

                         // =====================
                         // class ScopedAttribute
                         // =====================

class ScopedAttribute {
    // Provides a scoped guard that sets BALL attributes for &quot;serviceId&quot; and
    // &quot;uuid&quot; in the current thread.

    // DATA
    ScopedAttribute_Container        d_container;  // contains the attribute

    const AttributeContext::iterator d_it;         // reference to attribute
                                                   // container

    // NOT IMPLEMENTED
    ScopedAttribute(const ScopedAttribute&amp;);
    ScopedAttribute&amp; operator=(const ScopedAttribute&amp;);

  public:
    // CREATORS
    ScopedAttribute(const char         *name,
                    const bsl::string&amp;  value,
                    bslma::Allocator   *basicAllocator = 0);
    ScopedAttribute(const char         *name,
                    int                 value,
                    bslma::Allocator   *basicAllocator = 0);
    ScopedAttribute(const char         *name,
                    bsls::Types::Int64  value,
                    bslma::Allocator   *basicAllocator = 0);
        // Set BALL logging attributes for the current thread for the scope of
        // this object, associating the specified &#39;name&#39; with the specified
        // &#39;value&#39;.  Optionally specify a &#39;basicAllocator&#39; used to supply
        // memory.  If &#39;basicAllocator&#39; is 0 or unspecified, the currently
        // installed default allocator is used.

    ~ScopedAttribute();
        // Remove the attributes managed by this object from the BALL system,
        // and destroy this object.

};

// ============================================================================
//                              INLINE DEFINITIONS
// ============================================================================

                    // -------------------------------
                    // class ScopedAttribute_Container
                    // -------------------------------

// CREATORS
inline
ScopedAttribute_Container::ScopedAttribute_Container(
                                            const char         *name,
                                            const bsl::string&amp;  value,
                                            bslma::Allocator   *basicAllocator)
: d_attribute(name, value.c_str(), basicAllocator)
{
}

inline
ScopedAttribute_Container::ScopedAttribute_Container(
                                            const char         *name,
                                            int                 value,
                                            bslma::Allocator   *basicAllocator)
    : d_attribute(name, value, basicAllocator)
{
}

inline
ScopedAttribute_Container::ScopedAttribute_Container(
                                            const char         *name,
                                            bsls::Types::Int64  value,
                                            bslma::Allocator   *basicAllocator)
: d_attribute(name, value, basicAllocator)
{
}

// ACCESSORS
inline
bool ScopedAttribute_Container::hasValue(const Attribute&amp; value) const
{
    return d_attribute == value;
}

                         // ---------------------
                         // class ScopedAttribute
                         // ---------------------

// CREATORS
inline
ScopedAttribute::ScopedAttribute(const char         *name,
                                 const bsl::string&amp;  value,
                                 bslma::Allocator   *basicAllocator)
: d_container(name, value, basicAllocator)
, d_it(AttributeContext::getContext()-&gt;addAttributes(&amp;d_container))
{
}

inline
ScopedAttribute::ScopedAttribute(const char         *name,
                                 int                 value,
                                 bslma::Allocator   *basicAllocator)
: d_container(name, value, basicAllocator)
, d_it(AttributeContext::getContext()-&gt;addAttributes(&amp;d_container))
{
}

inline
ScopedAttribute::ScopedAttribute(const char         *name,
                                 bsls::Types::Int64  value,
                                 bslma::Allocator   *basicAllocator)
: d_container(name, value, basicAllocator)
, d_it(AttributeContext::getContext()-&gt;addAttributes(&amp;d_container))
{
}

inline
ScopedAttribute::~ScopedAttribute()
{
    AttributeContext::getContext()-&gt;removeAttributes(d_it);
}

}  // close package namespace

}  // close enterprise namespace

#endif

// ----------------------------------------------------------------------------
// Copyright 2015 Bloomberg Finance L.P.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// ----------------------------- END-OF-FILE ----------------------------------
</pre>
</body>
</html>
