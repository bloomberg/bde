<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>BDE 3.0: balst_assertionlogger Component</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <style>
      div.hanging {
        padding-left: 0.75in;
        text-indent: -0.50in;
      }
      div.unhanging {
        text-indent:     0in;
      }
      a.glossary {
        font-weight: bold;
        font-style: italic;
      }
    </style>
</head>
<!--
<body onload='searchBox.OnSelectItem(0);'>
-->
<body>

<table border=2 cellspacing=0 cellpadding=0 align=center>
<tr>
 <td valign=top align=center>
 <p align=center><b><i>Quick Links:</i></b></p>
 </td>
 <td valign=top align=center>
 <p align=center>
<a class="qindex" href="group__bal.html" target="_blank">bal</a> | <a class="qindex" href="group__bbl.html" target="_blank">bbl</a> | <a class="qindex" href="group__bdl.html" target="_blank">bdl</a> | <a class="qindex" href="group__bsl.html" target="_blank">bsl</a> | <a class="qindex" href="group__btl.html" target="_blank">btl</a>
 </td>
 </tr>
 </table>

  </div>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="components.html"><span>Components</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a>  </div>
  <div class="headertitle">
<h1>Component balst_assertionlogger<br/>
<small>
[<a class="el" href="group__balst.html">Package balst</a>]</small>
</h1>  </div>
</div>
<div class="contents">

<p>Provide configurable logging handler for assertion failures.  
<a href="#_details">More...</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">class &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classAssertionLogger.html">AssertionLogger</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<dl class="user"><dt><b>Outline</b></dt><dd><ul>
<li>
<a href="#1">Purpose</a> </li>
<li>
<a href="#2">Classes</a> </li>
<li>
<a href="#3">Description</a> <ul>
<li>
<a href="#3.1">Usage</a> <ul>
<li>
<a href="#3.1.1">Example 1: String Buffer Overflow</a> </li>
</ul>
</li>
</ul>
</li>
</ul>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="purpose"></a> <a class="anchor" id="1"></a> </dd></dl>
<dl class="user"><dt><b>Purpose: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>Provide configurable logging handler for assertion failures. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="classes"></a> <a class="anchor" id="2"></a> </dd></dl>
<dl class="user"><dt><b>Classes: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><table class="doxtable">
<tr>
<td>balst::AssertionLogger </td><td>mechanism class for logging assertion failures  </td></tr>
</table>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="group__bsls__assert.html" title="Provide build-specific, runtime-configurable assertion macros.">Component bsls_assert</a> </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="description"></a> <a class="anchor" id="3"></a> </dd></dl>
<dl class="user"><dt><b>Description: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>This component defines an assert handling mechanism that logs the function call stack at the point of the assertion (using the BAEL logging framework), and then returns to the caller allowing program execution to continue. This component provides methods to enable or disable logging, which can be called throughout the execution of the program. These methods allow running tasks to adjust the run-time cost of generating assertion failure information in a production environment. The intent of providing a non-terminating assertion handler is to allow previously disabled assertions to be enabled (and new assertions to be added) without causing crashes in production applications that have such failures. The premise is that the bugs uncovered in "legacy" code by newly enabled assertions may be benign, and more damage may be done by terminating the task in a production environment than by allowing execution to continue and the bug to be addressed in a more orderly fashion. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="usage"></a> <a class="anchor" id="description.usage"></a> <a class="anchor" id="3.1"></a> </dd></dl>
<dl class="user"><dt><b>Usage: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>This section illustrates intended use of this component. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="example_1~3A_string_buffer_overflow"></a> <a class="anchor" id="usage.example_1~3A_string_buffer_overflow"></a> <a class="anchor" id="description.usage.example_1~3A_string_buffer_overflow"></a> <a class="anchor" id="example_1"></a> <a class="anchor" id="usage.example_1"></a> <a class="anchor" id="description.usage.example_1"></a> <a class="anchor" id="3.1.1"></a> </dd></dl>
<dl class="user"><dt><b>Example 1: String Buffer Overflow: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>Suppose we are responsible for maintaining a large amount of legacy code that frequently passes internal buffers of string objects to methods that manipulate those buffers's contents. We expect that these methods occasionally overrun their supplied buffer, so we introduce an assertion to the destructor of string that will alert us to such a buffer overrun. Unfortunately, our legacy code does not have effective unit tests, and we want to avoid causing crashes in production applications, since we expect that frequently the overflow in "working" legacy code is only overwriting the null terminating byte and is otherwise harmless. We can use the <code>bdesu::AssertionLogger::failTrace</code> assertion-failure callback to replace the default callback, which aborts the task, with one that will log the failure and the call-stack at which it occurred. </dd></dl>
<dl class="user"><dt><b></b></dt><dd>First, we write a dubious legacy date routine: <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="keywordtype">void</span> getDayAndDate(<span class="keywordtype">char</span> *buf, <span class="keyword">const</span> <span class="keyword">struct</span> tm *datetime)
      <span class="comment">// Format the specified &#39;datetime&#39; into the specified &#39;buf&#39; as</span>
      <span class="comment">// &quot;Weekday, Month N&quot;, e.g., &quot;Monday, May 6&quot;.</span>
  {
      <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> months[] = {
          <span class="stringliteral">&quot;January&quot;</span>, <span class="stringliteral">&quot;February&quot;</span>, <span class="stringliteral">&quot;March&quot;</span>, <span class="stringliteral">&quot;April&quot;</span>, <span class="stringliteral">&quot;May&quot;</span>, <span class="stringliteral">&quot;June&quot;</span>, <span class="stringliteral">&quot;July&quot;</span>,
          <span class="stringliteral">&quot;August&quot;</span>, <span class="stringliteral">&quot;September&quot;</span>, <span class="stringliteral">&quot;October&quot;</span>, <span class="stringliteral">&quot;November&quot;</span>, <span class="stringliteral">&quot;December&quot;</span>       };
      <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> days[] = {
          <span class="stringliteral">&quot;Sunday&quot;</span>, <span class="stringliteral">&quot;Monday&quot;</span>, <span class="stringliteral">&quot;Tuesday&quot;</span>, <span class="stringliteral">&quot;Wednesday&quot;</span>, <span class="stringliteral">&quot;Thursday&quot;</span>, <span class="stringliteral">&quot;Friday&quot;</span>,
          <span class="stringliteral">&quot;Saturday&quot;</span>                                                     };
      <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> digits[] = {
          <span class="stringliteral">&quot;0&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, <span class="stringliteral">&quot;2&quot;</span>, <span class="stringliteral">&quot;3&quot;</span>, <span class="stringliteral">&quot;4&quot;</span>, <span class="stringliteral">&quot;5&quot;</span>, <span class="stringliteral">&quot;6&quot;</span>, <span class="stringliteral">&quot;7&quot;</span>, <span class="stringliteral">&quot;8&quot;</span>, <span class="stringliteral">&quot;9&quot;</span>               };
      *buf = 0;
      strcat(buf, days[datetime-&gt;tm_wday]);
      strcat(buf, <span class="stringliteral">&quot;, &quot;</span>);
      strcat(buf, months[datetime-&gt;tm_mon]);
      strcat(buf, <span class="stringliteral">&quot; &quot;</span>);
      <span class="keywordflow">if</span> (datetime-&gt;tm_mday &gt;= 10) {
          strcat(buf, digits[datetime-&gt;tm_mday / 10]);
      }
      strcat(buf, digits[datetime-&gt;tm_mday % 10]);
  }
</pre></div><br/>
<br/>
 Then, we write a buggy function that will inadvertently over-write the null terminator in a <code>bsl::string</code>: <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="keywordtype">void</span> getLateSummerDate(<a class="code" href="classbsl_1_1basic__string.html">bsl::string</a> *date)
      <span class="comment">// &quot;Try to remember a time in ...&quot;</span>
  {
      <span class="keyword">struct </span>tm datetime = { 0, 0, 0, 11, 8, 113, 3, 0, 1 };
      date-&gt;<a class="code" href="group__bslstl__string.html#ga25b862783d3d32a02bff9aa4c9e1a4c4">resize</a>(22);  <span class="comment">// Surely this is long enough...</span>
      getDayAndDate(const_cast&lt;char *&gt;(date-&gt;<a class="code" href="group__bslstl__string.html#gae8d40a93bd2ebc7ae696c6f63b3995c9">c_str</a>()), &amp;datetime);
  }
</pre></div><br/>
<br/>
 Next, we embed this code deep in the heart of a large system, compile it with optimization, and have it run, apparently successfully, for several years. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="keywordtype">void</span> big_important_highly_visible_subsystem()
      <span class="comment">// If this crashes, you&#39;re fired!</span>
  {
      <span class="comment">// lots of code...</span>
      <a class="code" href="classbsl_1_1basic__string.html">bsl::string</a> s;
      getLateSummerDate(&amp;s);
      <span class="comment">// lots more code...</span>
  }
</pre></div><br/>
<br/>
 Now, someone comes along and insists that all assertions must be turned on due to heightened auditing requirements. He is prevailed upon to agree that logging the assertions is preferable to crashing. We do so: <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="keywordtype">void</span> protect_the_subsystem()
      <span class="comment">// Protect your job, too!</span>
  {
      <a class="code" href="classbsls_1_1AssertFailureHandlerGuard.html">bsls::AssertFailureHandlerGuard</a> guard(
                            balst::AssertionLogger::assertionFailureHandler);
      big_important_highly_visible_subsystem();
  }
</pre></div><br/>
<br/>
 Finally, we activate the logging handler and find logged errors similar to the following, indicating bugs that must be fixed. The hexadecimal stack trace can be merged against the executable program to determine the location of the error. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <span class="comment">// [ [ ... balst_assertionlogger.cpp 55 Assertion.Failure 32</span>
  <span class="comment">// Assertion failed: (*this)[this-&gt;d_length] == CHAR_TYPE(),</span>
  <span class="comment">// file .../bslstl_string.h, line 3407</span>
  <span class="comment">// For stack trace, run &#39;showfunc.tsk &lt;your_program_binary&gt;</span>
  <span class="comment">//    0x805d831 0x804f8cc 0x804e3f9 ...</span>
  <span class="comment">// ]  { } ]</span>
</pre></div><br/>
<br/>
 </dd></dl>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Oct 15 2015 14:33:34 for BDE Release 3.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
