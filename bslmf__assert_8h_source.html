<!doctype HTML public "-//W3C//DTD HTML 4.0 Frameset//EN">
<html>
<title>BDE 2.16 BETA</title>
<html>
<pre>
// bslmf_assert.h                                                     -*-C++-*-
#ifndef INCLUDED_BSLMF_ASSERT
#define INCLUDED_BSLMF_ASSERT

#ifndef INCLUDED_BSLS_IDENT
#include &lt;bsls_ident.h&gt;
#endif
BSLS_IDENT(&quot;$Id: $&quot;)

//@PURPOSE: Provide a compile-time assertion facility.
//
//@CLASSES:
//
//@MACROS:
//  BSLMF_ASSERT: compile-time assert macro
//
//@DESCRIPTION: This component defines a macro that will generate a
// compile-time error if its constant integral expression argument evaluates to
// false (i.e., a value of &#39;0&#39;).  The &#39;BSLMF_ASSERT&#39; macro is similar to the
// standard run-time &#39;assert&#39; macro, except that its argument is evaluated at
// compile-time, it produces no executable code, and it can be used safely in
// header files.
//..
//  BSLMF_ASSERT(sizeof(int) &gt;= sizeof(char));    // OK
//  BSLMF_ASSERT(sizeof(double) &lt; sizeof(char));  // COMPILE ERROR!
//..
// The second line will result in a compile error with a message stating that
// the type &#39;BSLMF_COMPILE_TIME_ASSERTION_FAILURE&#39; is incomplete, usually
// preceded by the file and line number where the macro was used.  The
// following errata is typical of most compilers:
//..
//  $ CC -g myfile.cpp
//  &quot;myfile.cpp&quot;, line 86: Error: The type
//  &quot;BSLMF_COMPILE_TIME_ASSERTION_FAILURE&lt;0&gt;&quot; is incomplete.
//  1 Error(s) detected.
//..
// If the macro argument if true, the macro will generate an innocuous
// &#39;typedef&#39; with a name that is the concatenation of the symbol
// &#39;bslmf::Assert&#39;, and the value of &#39;__LINE__&#39; (which will be the line number
// in the file where the macro was called).  For example, the first line from
// the example above might result in the following statement:
//..
//  typedef bslmf::AssertTest&lt;1&gt; bslmf_Assert_85;
//..
// Note that these generated typedefs are implementation details of the
// compile-time checking facility and are not intended to be used directly
// outside of this component.
//
// Attempting to invoke &#39;BSLMF_ASSERT&#39; on a non-compile-time value will
// typically result in a compilation error.
//
// &#39;BSLMF_ASSERT&#39; can be used at namespace, class, and function scope to assert
// compile-time conditions.  !WARNING:! a compiler bug on certain platforms
// produces an error when the &#39;BSLMF_ASSERT&#39; macro is used more than once on
// the *same* line in class scope.
//..
//  +---------------------------------------------
//  | // mytype.h
//  | #ifndef INCLUDED_BSLMF_ASSERT
//  | #include &lt;bslmf_assert.h&gt;
//  | #endif
//  |
//  | class MyType {
//  |     BSLMF_ASSERT(sizeof(int) &gt;= sizeof(char));  // OK
//  |     BSLMF_ASSERT(sizeof(int) &gt;= sizeof(char));  // OK
//  |     BSLMF_ASSERT(1 == 1);                       // OK
//  |     BSLMF_ASSERT(1 == 1); BSLMF_ASSERT(1 == 1); // SAME LINE - MIGHT
//  |                                                 // CAUSE ERROR!
//  |
//  |     int d_data;
//  |     ...
//  |     void foo();
//  |     ...
//  | };
//
//        +---------------------------------------------
//        | // mytype.cpp
//        | #include &lt;mytype.h&gt;
//        | #include &lt;bslmf_assert.h&gt;
//        |
//        | BSLMF_ASSERT(sizeof(int) &gt;= sizeof(char));
//        |
//        | void MyType::foo()
//        | {
//        |     BSLMF_ASSERT(sizeof(int) &gt;= sizeof(char));
//        |     ...
//        | }
//..

#ifndef INCLUDED_BSLSCM_VERSION
#include &lt;bslscm_version.h&gt;
#endif

#ifndef INCLUDED_BSLS_COMPILERFEATURES
#include &lt;bsls_compilerfeatures.h&gt;
#endif

#ifndef INCLUDED_BSLS_PLATFORM
#include &lt;bsls_platform.h&gt;
#endif

#ifdef BSLS_COMPILERFEATURES_SUPPORT_STATIC_ASSERT
#define BSLMF_ASSERT(BSLMF_CONSTANT_EXPRESSION) \
    static_assert((BSLMF_CONSTANT_EXPRESSION), #BSLMF_CONSTANT_EXPRESSION)
#else

namespace BloombergLP {

                             // ==============
                             // Support macros
                             // ==============

#define BSLMF_ASSERT_CAT(X, Y) BSLMF_ASSERT_CAT_IMP1(X, Y)
#define BSLMF_ASSERT_CAT_IMP1(X, Y) BSLMF_ASSERT_CAT_IMP2(X, Y)
#define BSLMF_ASSERT_CAT_IMP2(X, Y) X##Y

                             // =============
                             // Support types
                             // =============

#if defined(BSLS_PLATFORM_CMP_SUN)

// Using a different implementation on Sun; see BSLMF_ASSERT for details.

namespace bslmf {

struct Assert_TrueType {
    typedef int BSLMF_COMPILE_TIME_ASSERTION_FAILURE;
};

struct Assert_FalseType {
};

template &lt;bool COND&gt;
struct Assert_If : Assert_TrueType {
};

template &lt;&gt;
struct Assert_If&lt;false&gt; : Assert_FalseType {
};

}  // close package namespace

#else

template &lt;int INTEGER&gt;
struct BSLMF_COMPILE_TIME_ASSERTION_FAILURE;
    // Declared but not defined.  If assert macro references this type, then
    // compilation will fail (assert failure).

template &lt;&gt;
struct BSLMF_COMPILE_TIME_ASSERTION_FAILURE&lt;1&gt; {
    // Specialization for value 1 (true).  Referencing this specialization will
    // allow compilation to succeed (assert succeeded).

    enum { VALUE = 1 };
};

namespace bslmf {

template &lt;int INTEGER&gt;
struct AssertTest {
    // Instantiating this type involves instantiating its template parameter.
    // This dummy type is just used to force instantiation of a meta-function
    // used as its argument.
};

}  // close package namespace

#endif

                             // ==================
                             // macro BSLMF_ASSERT
                             // ==================

#if defined(BSLS_PLATFORM_CMP_SUN)

// The usual definition of the &#39;BSLMF_ASSERT&#39; macro doesn&#39;t work with SunCC
// (version 10 and below) inside template classes.  Note that Sun CC has a
// quite non-conformant (read &#39;broken&#39;) template instantiation mechanism.  See
// DRQS 29636421 for an example of code Sun CC didn&#39;t compile correctly with
// the usual definition of &#39;BSLMF_ASSERT&#39;.  Below is the definition that works
// more reliably.  This definition is not well-formed, it just happens to work
// with SunCC.  So don&#39;t use it with other compilers.

#define BSLMF_ASSERT(expr)                                         \
    struct BSLMF_ASSERT_CAT(bslmf_Assert_, __LINE__)              \
        : ::BloombergLP::bslmf::Assert_If&lt;!!(int)(expr)&gt;           \
    {                                                              \
        BSLMF_COMPILE_TIME_ASSERTION_FAILURE * dummy;              \
    };                                                             \
                                                                   \
    enum { BSLMF_ASSERT_CAT(bslmf_Assert_Check_, __LINE__)        \
           = sizeof(BSLMF_ASSERT_CAT(bslmf_Assert_, __LINE__)) }  \

#elif defined(BSLS_PLATFORM_CMP_MSVC)
// MSVC: __LINE__ macro breaks when /ZI is used (see Q199057 or KB199057)

#define BSLMF_ASSERT(expr) \
typedef BloombergLP::bslmf::AssertTest&lt; \
    sizeof(BloombergLP::BSLMF_COMPILE_TIME_ASSERTION_FAILURE&lt;!!(int)(expr)&gt;)&gt; \
                bslmf_Assert_MSVC_ZI_BUG

#else

#define BSLMF_ASSERT(expr) \
typedef BloombergLP::bslmf::AssertTest&lt; \
    sizeof(BloombergLP::BSLMF_COMPILE_TIME_ASSERTION_FAILURE&lt;!!(int)(expr)&gt;)&gt; \
                BSLMF_ASSERT_CAT(bslmf_Assert_, __LINE__)

#endif


}  // close enterprise namespace

#endif  // BSLS_COMPILERFEATURES_SUPPORT_STATIC_ASSERT

#endif

// ----------------------------------------------------------------------------
// Copyright (C) 2012 Bloomberg L.P.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the &quot;Software&quot;), to
// deal in the Software without restriction, including without limitation the
// rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
// sell copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
// FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
// IN THE SOFTWARE.
// ----------------------------- END-OF-FILE ----------------------------------
</pre>
</body>
</html>
