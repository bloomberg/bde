<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>BDE 3.0: balm_publicationscheduler Component</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <style>
      div.hanging {
        padding-left: 0.75in;
        text-indent: -0.50in;
      }
      div.unhanging {
        text-indent:     0in;
      }
      a.glossary {
        font-weight: bold;
        font-style: italic;
      }
    </style>
</head>
<!--
<body onload='searchBox.OnSelectItem(0);'>
-->
<body>

<table border=2 cellspacing=0 cellpadding=0 align=center>
<tr>
 <td valign=top align=center>
 <p align=center><b><i>Quick Links:</i></b></p>
 </td>
 <td valign=top align=center>
 <p align=center>
<a class="qindex" href="group__bal.html" target="_blank">bal</a> | <a class="qindex" href="group__bbl.html" target="_blank">bbl</a> | <a class="qindex" href="group__bdl.html" target="_blank">bdl</a> | <a class="qindex" href="group__bsl.html" target="_blank">bsl</a> | <a class="qindex" href="group__btl.html" target="_blank">btl</a>
 </td>
 </tr>
 </table>

  </div>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="components.html"><span>Components</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#namespaces">Namespaces</a>  </div>
  <div class="headertitle">
<h1>Component balm_publicationscheduler<br/>
<small>
[<a class="el" href="group__balm.html">Package balm</a>]</small>
</h1>  </div>
</div>
<div class="contents">

<p>Provide a scheduler for publishing metrics.  
<a href="#_details">More...</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacebalm.html">balm</a></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<dl class="user"><dt><b>Outline</b></dt><dd><ul>
<li>
<a href="#1">Purpose</a> </li>
<li>
<a href="#2">Classes</a> </li>
<li>
<a href="#3">Description</a> <ul>
<li>
<a href="#3.1">Thread Safety</a> </li>
<li>
<a href="#3.2">Usage</a> </li>
</ul>
</li>
</ul>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="purpose"></a> <a class="anchor" id="1"></a> </dd></dl>
<dl class="user"><dt><b>Purpose: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>Provide a scheduler for publishing metrics. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="classes"></a> <a class="anchor" id="2"></a> </dd></dl>
<dl class="user"><dt><b>Classes: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><table class="doxtable">
<tr>
<td><a class="el" href="classbalm_1_1PublicationScheduler.html">balm::PublicationScheduler</a> </td><td>a scheduler for publishing metrics  </td></tr>
</table>
</dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="group__balm__metricsmanager.html" title="Provide a manager for recording and publishing metric data.">Component balm_metricsmanager</a> </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="description"></a> <a class="anchor" id="3"></a> </dd></dl>
<dl class="user"><dt><b>Description: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>This component defines a <code><a class="el" href="classbalm_1_1PublicationScheduler.html">balm::PublicationScheduler</a></code> class that provides a scheduling mechanism for the publication of metrics. At construction, a <code><a class="el" href="classbalm_1_1PublicationScheduler.html">balm::PublicationScheduler</a></code> is provided the addresses of a <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code> and a <code><a class="el" href="classbdlmt_1_1TimerEventScheduler.html">bdlmt::TimerEventScheduler</a></code>. The publication scheduler provides a <code>scheduleCategory</code> method that schedules an individual metric category to be published repeatedly at a given interval, and a <code>setDefaultSchedule</code> method that schedules the publication of any category not given an individual schedule. The <code><a class="el" href="classbalm_1_1PublicationScheduler.html">balm::PublicationScheduler</a></code> creates timer events using the <code><a class="el" href="classbdlmt_1_1TimerEventScheduler.html">bdlmt::TimerEventScheduler</a></code>. At the end of a scheduled time interval, the publication scheduler invokes the metrics manager's <code>publish</code> operation with the set of categories to publish. Note that the publication scheduler will combine categories that occur at the same frequency into a single invocation of the metrics manager's <code>publish</code> operation. The publication scheduler also provides a method to cancel the publication of a particular category, or of all categories. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="thread_safety"></a> <a class="anchor" id="description.thread_safety"></a> <a class="anchor" id="3.1"></a> </dd></dl>
<dl class="user"><dt><b>Thread Safety: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><code><a class="el" href="classbalm_1_1PublicationScheduler.html">balm::PublicationScheduler</a></code> is fully <em>thread-safe</em>, meaning that all non-creator operations on a given instance can be safely invoked simultaneously from multiple threads. </dd></dl>
<dl class="user"><dt><b></b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd><a class="anchor" id="usage"></a> <a class="anchor" id="description.usage"></a> <a class="anchor" id="3.2"></a> </dd></dl>
<dl class="user"><dt><b>Usage: </b></dt><dd></dd></dl>
<dl class="user"><dt><b></b></dt><dd>The following example demonstrates how to use <code><a class="el" href="classbalm_1_1PublicationScheduler.html">balm::PublicationScheduler</a></code>. Before instantiating the publication scheduler, we create a <code><a class="el" href="classbdlmt_1_1TimerEventScheduler.html">bdlmt::TimerEventScheduler</a></code> as well as a <code><a class="el" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a></code>. We obtain collectors for three different metric categories, "A", "B", and "C", that we will use to generate metric values for publication. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <a class="code" href="classbslma_1_1Allocator.html">bslma::Allocator</a>         *allocator = <a class="code" href="structbslma_1_1Default.html#a418cbb340801caa455fd33177d1ff8d5">bslma::Default::allocator</a>(0);
  <a class="code" href="classbdlmt_1_1TimerEventScheduler.html">bdlmt::TimerEventScheduler</a>  timer(allocator);
  <a class="code" href="classbalm_1_1MetricsManager.html">balm::MetricsManager</a>       manager(allocator);

  <a class="code" href="classbalm_1_1Collector.html">balm::Collector</a> *<a class="code" href="bdlf__bind__test_8h.html#a2487e64b489c5eaa866ce223b64a6713">A</a> = manager.<a class="code" href="classbalm_1_1MetricsManager.html#a536b8e60b798321cf64d3168ee364900">collectorRepository</a>().getDefaultCollector(
                                                                   <span class="stringliteral">&quot;A&quot;</span>, <span class="stringliteral">&quot;a&quot;</span>);
  <a class="code" href="classbalm_1_1Collector.html">balm::Collector</a> *B = manager.<a class="code" href="classbalm_1_1MetricsManager.html#a536b8e60b798321cf64d3168ee364900">collectorRepository</a>().getDefaultCollector(
                                                                   <span class="stringliteral">&quot;B&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>);
  <a class="code" href="classbalm_1_1Collector.html">balm::Collector</a> *C = manager.<a class="code" href="classbalm_1_1MetricsManager.html#a536b8e60b798321cf64d3168ee364900">collectorRepository</a>().getDefaultCollector(
                                                                   <span class="stringliteral">&quot;C&quot;</span>, <span class="stringliteral">&quot;c&quot;</span>);
</pre></div><br/>
<br/>
 We now create an instance of <code>SimpleStreamPublisher</code>, which implements the <code><a class="el" href="classbalm_1_1Publisher.html">balm::Publisher</a></code> protocol. Note that <code>SimpleStreamPublisher</code> is an example implementation of the <code><a class="el" href="classbalm_1_1Publisher.html">balm::Publisher</a></code> protocol defined in the <code>balm_publisher</code> component. In practice, clients typically use a standard publisher class (e.g., <code><a class="el" href="classbalm_1_1StreamPublisher.html">balm::StreamPublisher</a></code>). <br/>
<br/>
<div class="fragment"><pre class="fragment">      <a class="code" href="classbsl_1_1shared__ptr.html">bsl::shared_ptr&lt;balm::Publisher&gt;</a> publisher(
                          <span class="keyword">new</span> (*allocator) SimpleStreamPublisher(bsl::cout),
                          allocator);
</pre></div><br/>
<br/>
 We now register the <code>publisher</code> we have created with the metrics <code>manager</code> to publish our categories. Then, we <code>start</code> the timer-event scheduler we will supply to the <code><a class="el" href="classbalm_1_1PublicationScheduler.html">balm::PublicationScheduler</a></code>. <br/>
<br/>
<div class="fragment"><pre class="fragment">  manager.<a class="code" href="classbalm_1_1MetricsManager.html#a3ab6f3eec3141e6c3af9e1c702548348">addGeneralPublisher</a>(publisher);
  timer.start();
</pre></div><br/>
<br/>
 Now we construct a <code><a class="el" href="classbalm_1_1PublicationScheduler.html">balm::PublicationScheduler</a></code> and pass it the respective addresses of both the metrics manager and the timer-event scheduler. We schedule the publication of category "A" and "B" every .05 seconds, then we set the scheduled default publication to every .10 seconds. Note that those time intervals were chosen to ensure fast and consistent output for this example. In normal usage the interval between publications should be large enough to ensure that metric publication does not negatively affect the performance of the application (a 30 second interval is typical). <br/>
<br/>
<div class="fragment"><pre class="fragment">  <a class="code" href="classbalm_1_1PublicationScheduler.html">balm::PublicationScheduler</a> scheduler(&amp;manager, &amp;timer, allocator);
  scheduler.scheduleCategory(<span class="stringliteral">&quot;A&quot;</span>, <a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a>(.05));
  scheduler.scheduleCategory(<span class="stringliteral">&quot;B&quot;</span>, <a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a>(.05));
  scheduler.setDefaultSchedule(<a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a>(.10));
</pre></div><br/>
<br/>
 We can use the accessor operations to verify the schedule that we have specified. <br/>
<br/>
<div class="fragment"><pre class="fragment">  <a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a> intervalA, intervalB, intervalC, defaultInterval;
  assert( scheduler.findCategorySchedule(&amp;intervalA, <span class="stringliteral">&quot;A&quot;</span>));
  assert( scheduler.findCategorySchedule(&amp;intervalB, <span class="stringliteral">&quot;B&quot;</span>));
  assert(!scheduler.findCategorySchedule(&amp;intervalC, <span class="stringliteral">&quot;C&quot;</span>));
  assert( scheduler.getDefaultSchedule(&amp;defaultInterval));

  assert(<a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a>(.05) == intervalA);
  assert(<a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a>(.05) == intervalB);
  assert(<a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a>(.10) == defaultInterval);
</pre></div><br/>
<br/>
 Finally we add a couple of metrics and wait just over .1 seconds. <br/>
<br/>
<div class="fragment"><pre class="fragment">  A-&gt;<a class="code" href="classbalm_1_1Collector.html#ab6779d840b8747960033d7f104a4113f">update</a>(1.0);
  B-&gt;<a class="code" href="classbalm_1_1Collector.html#ab6779d840b8747960033d7f104a4113f">update</a>(2.0);
  C-&gt;<a class="code" href="classbalm_1_1Collector.html#ab6779d840b8747960033d7f104a4113f">update</a>(3.0);
  <a class="code" href="structbslmt_1_1ThreadUtil.html#a667b0f54d6c038c8ecb851ca66dc0529">bslmt::ThreadUtil::sleep</a>(<a class="code" href="classbsls_1_1TimeInterval.html">bsls::TimeInterval</a>(.11));
</pre></div><br/>
<br/>
 The output of the publication should look similar to: <br/>
<br/>
<div class="fragment"><pre class="fragment"> 19NOV2008_18:34:26.766+0000    2 Records   0.0517s Elapsed <a class="code" href="namespacebdet.html#aac65e816e68f5285b127a9071544c5c1">Time</a>
         A.a [count = 1, total = 1, min = 1, max = 1]
         B.b [count = 1, total = 2, min = 2, max = 2]
 19NOV2008_18:34:26.816+0000    2 Records   0.050183s Elapsed <a class="code" href="namespacebdet.html#aac65e816e68f5285b127a9071544c5c1">Time</a>
         A.a [count = 0, total = 0, min = inf, max = -inf]
         B.b [count = 0, total = 0, min = inf, max = -inf]
 19NOV2008_18:34:26.817+0000    1 Records   0.102473s Elapsed <a class="code" href="namespacebdet.html#aac65e816e68f5285b127a9071544c5c1">Time</a>
         C.c [count = 1, total = 3, min = 3, max = 3]
</pre></div><br/>
<br/>
 Note that category <code>C</code> is published as part of the scheduled default publication. Also note that categories <code>A</code> and <code>B</code> are emitted as a single publication: the scheduler combines categories published at the same frequency into a single publication event to minimize the number of times <code><a class="el" href="classbalm_1_1MetricsManager.html#a69768cef0059212f3a8c1f61942db302">balm::MetricsManager::publish</a></code> is invoked. </dd></dl>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Apr 1 2016 16:48:28 for BDE Release 3.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
