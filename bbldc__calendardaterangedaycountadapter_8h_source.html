<!doctype HTML public "-//W3C//DTD HTML 4.0 Frameset//EN">
<html>
<title>BDE 3.0</title>
<html>
<pre>
// bbldc_calendardaterangedaycountadapter.h                           -*-C++-*-
#ifndef INCLUDED_BBLDC_CALENDARDATERANGEDAYCOUNTADAPTER
#define INCLUDED_BBLDC_CALENDARDATERANGEDAYCOUNTADAPTER

#ifndef INCLUDED_BSLS_IDENT
#include &lt;bsls_ident.h&gt;
#endif
BSLS_IDENT(&quot;$Id: $&quot;)

//@PURPOSE: Provide a parameterized day-count convention implementation.
//
//@CLASSES:
//  bbldc::CalendarDateRangeDayCountAdapter: &#39;bbldc::DateRangeDayCount&#39; adapter
//
//@DESCRIPTION: This component provides a parameterized (template)
// implementation, &#39;bbldc::CalendarDateRangeDayCountAdapter&#39;, of the
// &#39;bbldc::DateRangeDayCount&#39; protocol.  The template argument can be any type
// supporting the following two class methods.
//..
//  int daysDiff(const bdlt::Date&amp;     beginDate,
//               const bdlt::Date&amp;     endDate,
//               const bdlt::Calendar&amp; calendar);
//
//  double yearsDiff(const bdlt::Date&amp;     beginDate,
//                   const bdlt::Date&amp;     endDate,
//                   const bdlt::Calendar&amp; calendar);
//..
// The template class &#39;bbldc::CalendarDateRangeDayCountAdapter&#39; provides
// convenient support for run-time polymorphic choice of day-count conventions
// (via conventional use of a base-class pointer or reference) without having
// to implement each derived type explicitly.  In this sense,
// &#39;bbldc::CalendarDateRangeDayCountAdapter&#39; adapts the various concrete
// calendar-based day-count convention classes (e.g., &#39;bbldc::CalendarBus252&#39;)
// to a run-time binding mechanism.
//
// The &#39;bbldc::DateRangeDayCount&#39; protocol requires two methods, &#39;firstDate&#39;
// and &#39;lastDate&#39;, that define a date range for which calculations are valid,
// to reflect the valid range of, say, a calendar required for the
// computations.  For &quot;calendar&quot; day-count implementations, the valid date
// range is the valid range of the calendar.
//
///Usage
///-----
// This section illustrates intended use of this component.
//
///Example 1: Adapting &#39;bbldc::CalendarBus252&#39;
///- - - - - - - - - - - - - - - - - - - - - -
// This example shows the procedure for using
// &#39;bbldc::CalendarDateRangeDayCountAdapter&#39; to adapt the
// &#39;bbldc::CalendarBus252&#39; day-count convention to the
// &#39;bbldc::DateRangeDayCount&#39; protocol, and then the use of the day-count
// methods.  First, we create a &#39;calendar&#39; with a valid range spanning 2003 and
// typical weekend days:
//..
//  bdlt::Calendar calendar;
//  calendar.setValidRange(bdlt::Date(2003, 1, 1), bdlt::Date(2003, 12, 31));
//  calendar.addWeekendDay(bdlt::DayOfWeek::e_SUN);
//  calendar.addWeekendDay(bdlt::DayOfWeek::e_SAT);
//..
// Then, we define an instance of the adapted day-count convention and obtain a
// reference to the &#39;bbldc::DateRangeDayCount&#39;:
//..
//  const bbldc::CalendarDateRangeDayCountAdapter&lt;bbldc::CalendarBus252&gt;
//                                                             myDcc(calendar);
//  const bbldc::DateRangeDayCount&amp;                            dcc = myDcc;
//..
// Next, create two &#39;bdlt::Date&#39; variables, &#39;d1&#39; and &#39;d2&#39;, with which to use
// the day-count convention methods:
//..
//  const bdlt::Date d1(2003, 10, 19);
//  const bdlt::Date d2(2003, 12, 31);
//..
// Now, use the base-class reference to compute the day count between the two
// dates:
//..
//  const int daysDiff = dcc.daysDiff(d1, d2);
//  assert(52 == daysDiff);
//..
// Finally, use the base-class reference to compute the year fraction between
// the two dates:
//..
//  const double yearsDiff = dcc.yearsDiff(d1, d2);
//  // Need fuzzy comparison since &#39;yearsDiff&#39; is a &#39;double&#39;.
//  assert(yearsDiff &gt; 0.2063 &amp;&amp; yearsDiff &lt; 0.2064);
//..

#ifndef INCLUDED_BBLSCM_VERSION
#include &lt;bblscm_version.h&gt;
#endif

#ifndef INCLUDED_BBLDC_DATERANGEDAYCOUNT
#include &lt;bbldc_daterangedaycount.h&gt;
#endif

#ifndef INCLUDED_BDLT_CALENDAR
#include &lt;bdlt_calendar.h&gt;
#endif

#ifndef INCLUDED_BDLT_DATE
#include &lt;bdlt_date.h&gt;
#endif

#ifndef INCLUDED_BSLMA_ALLOCATOR
#include &lt;bslma_allocator.h&gt;
#endif

#ifndef INCLUDED_BSLMA_USESBSLMAALLOCATOR
#include &lt;bslma_usesbslmaallocator.h&gt;
#endif

#ifndef INCLUDED_BSLMF_INTEGRALCONSTANT
#include &lt;bslmf_integralconstant.h&gt;
#endif

#ifndef INCLUDED_BSLS_ASSERT
#include &lt;bsls_assert.h&gt;
#endif

namespace BloombergLP {
namespace bbldc {

                  // ======================================
                  // class CalendarDateRangeDayCountAdapter
                  // ======================================

template &lt;class CONVENTION&gt;
class CalendarDateRangeDayCountAdapter : public DateRangeDayCount {
    // This &#39;class&#39; provides an &quot;adapter&quot; from the specified &#39;CONVENTION&#39;, that
    // requires a calendar to compute the day count and the year fraction, to
    // the &#39;bbldc::DateRangeDayCount&#39; protocol that can be used for determining
    // values based on dates according to the day-count &#39;CONVENTION&#39;.

    // DATA
    bdlt::Calendar d_calendar;  // calendar used in all calculations

  private:
    // NOT IMPLEMENTED
    CalendarDateRangeDayCountAdapter(const CalendarDateRangeDayCountAdapter&amp;);
    CalendarDateRangeDayCountAdapter&amp; operator=(
                                      const CalendarDateRangeDayCountAdapter&amp;);

  public:
    // CREATORS
    CalendarDateRangeDayCountAdapter(
                                    const bdlt::Calendar&amp;  calendar,
                                    bslma::Allocator      *basicAllocator = 0);
        // Create a day-count adapter that uses the specified &#39;calendar&#39; during
        // invocations of &#39;daysDiff&#39; and &#39;yearsDiff&#39;.  Optionally specify a
        // &#39;basicAllocator&#39; used to supply memory.  If &#39;basicAllocator&#39; is 0,
        // the currently installed default allocator is used.

    virtual ~CalendarDateRangeDayCountAdapter();
        // Destroy this object.

    // ACCESSORS
    int daysDiff(const bdlt::Date&amp; beginDate, const bdlt::Date&amp; endDate) const;
        // Return the (signed) number of days between the specified &#39;beginDate&#39;
        // and &#39;endDate&#39; as per the &#39;CONVENTION&#39; template policy.  If
        // &#39;beginDate &lt;= endDate&#39;, then the result is non-negative.  The
        // behavior is undefined unless, for the &#39;calendar&#39; provided at
        // construction,
        // &#39;calendar.firstDate() &lt;= beginDate &lt;= calendar.lastDate()&#39; and
        // &#39;calendar.firstDate() &lt;= endDate &lt;= calendar.lastDate()&#39;.  Note that
        // reversing the order of &#39;beginDate&#39; and &#39;endDate&#39; negates the result.

    const bdlt::Date&amp; firstDate() const;
        // Return a reference providing non-modifiable access to
        // &#39;calendar.firstDate()&#39; for the &#39;calendar&#39; provided at construction.
        // Note that this value is the earliest date in the valid range of this
        // day-count convention adaptation.

    const bdlt::Date&amp; lastDate() const;
        // Return a reference providing non-modifiable access to
        // &#39;calendar.lastDate()&#39; for the &#39;calendar&#39; provided at construction.
        // Note that this value is the latest date in the valid range of this
        // day-count convention adaptation.

    double yearsDiff(const bdlt::Date&amp; beginDate,
                     const bdlt::Date&amp; endDate) const;
        // Return the (signed fractional) number of years between the specified
        // &#39;beginDate&#39; and &#39;endDate&#39; as per the &#39;CONVENTION&#39; template policy.
        // If &#39;beginDate &lt;= endDate&#39;, then the result is non-negative.  The
        // behavior is undefined unless, for the &#39;calendar&#39; provided at
        // construction,
        // &#39;calendar.firstDate() &lt;= beginDate &lt;= calendar.lastDate()&#39; and
        // &#39;calendar.firstDate() &lt;= endDate &lt;= calendar.lastDate()&#39;.  Note that
        // reversing the order of &#39;beginDate&#39; and &#39;endDate&#39; negates the result;
        // specifically, &#39;|yearsDiff(b, e) + yearsDiff(e, b)| &lt;= 1.0e-15&#39; for
        // all dates &#39;b&#39; and &#39;e&#39;.

                                  // Aspects

    bslma::Allocator *allocator() const;
        // Return the allocator used by this adapter to supply memory.
};

// ============================================================================
//                             INLINE DEFINITIONS
// ============================================================================

                  // --------------------------------------
                  // class CalendarDateRangeDayCountAdapter
                  // --------------------------------------

// CREATORS
template &lt;class CONVENTION&gt;
inline
CalendarDateRangeDayCountAdapter&lt;CONVENTION&gt;::CalendarDateRangeDayCountAdapter(
                                         const bdlt::Calendar&amp;  calendar,
                                         bslma::Allocator      *basicAllocator)
: d_calendar(calendar, basicAllocator)
{
}

template &lt;class CONVENTION&gt;
inline
CalendarDateRangeDayCountAdapter&lt;CONVENTION&gt;::
                                            ~CalendarDateRangeDayCountAdapter()
{
}

// ACCESSORS
template &lt;class CONVENTION&gt;
inline
int CalendarDateRangeDayCountAdapter&lt;CONVENTION&gt;::daysDiff(
                                               const bdlt::Date&amp; beginDate,
                                               const bdlt::Date&amp; endDate) const
{
    BSLS_ASSERT_SAFE(d_calendar.firstDate() &lt;= beginDate);
    BSLS_ASSERT_SAFE(                      beginDate &lt;= d_calendar.lastDate());
    BSLS_ASSERT_SAFE(d_calendar.firstDate() &lt;= endDate);
    BSLS_ASSERT_SAFE(                        endDate &lt;= d_calendar.lastDate());

    return CONVENTION::daysDiff(beginDate, endDate, d_calendar);
}

template &lt;class CONVENTION&gt;
inline
const bdlt::Date&amp; CalendarDateRangeDayCountAdapter&lt;CONVENTION&gt;::
                                                              firstDate() const
{
    return d_calendar.firstDate();
}

template &lt;class CONVENTION&gt;
inline
const bdlt::Date&amp; CalendarDateRangeDayCountAdapter&lt;CONVENTION&gt;::
                                                               lastDate() const
{
    return d_calendar.lastDate();
}

template &lt;class CONVENTION&gt;
inline
double CalendarDateRangeDayCountAdapter&lt;CONVENTION&gt;::yearsDiff(
                                               const bdlt::Date&amp; beginDate,
                                               const bdlt::Date&amp; endDate) const
{
    BSLS_ASSERT_SAFE(d_calendar.firstDate() &lt;= beginDate);
    BSLS_ASSERT_SAFE(                      beginDate &lt;= d_calendar.lastDate());
    BSLS_ASSERT_SAFE(d_calendar.firstDate() &lt;= endDate);
    BSLS_ASSERT_SAFE(                        endDate &lt;= d_calendar.lastDate());

    return CONVENTION::yearsDiff(beginDate, endDate, d_calendar);
}

                                  // Aspects

template &lt;class CONVENTION&gt;
inline
bslma::Allocator *CalendarDateRangeDayCountAdapter&lt;CONVENTION&gt;::
                                                              allocator() const
{
    return d_calendar.allocator();
}

}  // close package namespace
}  // close enterprise namespace

// TRAITS

namespace BloombergLP {
namespace bslma {

template &lt;class CONVENTION&gt;
struct UsesBslmaAllocator&lt;bbldc::CalendarDateRangeDayCountAdapter&lt;CONVENTION&gt; &gt;
                                                           : bsl::true_type {};

}  // close namespace bslma
}  // close enterprise namespace

#endif

// ----------------------------------------------------------------------------
// Copyright 2015 Bloomberg Finance L.P.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// ----------------------------- END-OF-FILE ----------------------------------
</pre>
</body>
</html>
