

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Avoiding Common Problems with Smart Pointers &mdash; BDE Documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/bde.css" type="text/css" />

  
  

  
  

  
    <link rel="canonical" href="https://bloomberg.github.io/articles/mpcheck.html" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BDE FAQ" href="../knowledge_base/faq.html" />
    <link rel="prev" title="BER Date-and-Time Format" href="ber_format.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> BDE Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Library Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../library_information/documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../library_information/build.html">Build Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../library_information/source_code.html">Source Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../library_information/supported_platforms.html">Supported Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes/release_notes.html">Release Notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Knowledge Base</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../knowledge_base/coding_standards.html">BDE C++ Coding Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge_base/resources_by_topic.html">Resources By Topic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../white_papers/index.html">White Papers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Articles</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting_started_with_aa.html">Getting Started Writing Allocator Aware Software (May 30, 2024)</a></li>
<li class="toctree-l2"><a class="reference internal" href="bsl_variant.html">bsl::variant: An Allocator-Aware Sum Type (December 25, 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpp20_project.html">BSL Support for C++20 (August 28, 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="fuzz_testing.html">Fuzz Testing (Feb 21, 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="bdljsn.html">Introducing bdljsn::Json (January 18, 2023)</a></li>
<li class="toctree-l2"><a class="reference internal" href="wyhash.html">Selecting wyhash as the Default Hash Algorithm (June 30, 2022)</a></li>
<li class="toctree-l2"><a class="reference internal" href="bde_4.0_chrono.html">bsl::chrono Integration with bsl and bdl (November 30, 2021)</a></li>
<li class="toctree-l2"><a class="reference internal" href="concurrent_queue_evaluation/paper.html">Concurrent Queue Evaluation (March 31, 2021)</a></li>
<li class="toctree-l2"><a class="reference internal" href="binary_decimal_conversion.html">Binary to Decimal and Back Again. (March 30, 2021)</a></li>
<li class="toctree-l2"><a class="reference internal" href="bsl_optional.html">bsl::optional: An Allocator-Aware Optional Type. (February 1, 2021)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ball_scoped_attributes.html">Adding Context to your Application Log. (January 6, 2021)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ber_format.html">BER Date and Time Format Specification. (January 9, 2020)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Avoiding Common Problems with Smart Pointers. (December 17, 2019)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://bloomberg.github.io/bde-resources/pdfs/BDETypeTaxonomy.pdf">Taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge_base/faq.html">BDE FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="fuzz_testing.html">Fuzz Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge_base/contributing.html">Contributing to BDE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://bloomberg.github.io/bde-tools">BBS Build System</a></li>
<li class="toctree-l1"><a class="reference external" href="https://bloomberg.github.io/bde-tools/misc/sim_cpp11_features.html">Simulating Variadic Templates</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BDE Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Articles</a> &raquo;</li>
        
      <li>Avoiding Common Problems with Smart Pointers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="../knowledge_base/faq.html" class="btn btn-neutral float-right" title="BDE FAQ" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
      
      
        <a href="ber_format.html" class="btn btn-neutral float-left" title="BER Date-and-Time Format" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p><em>Dec 17, 2019</em></p>
<div class="section" id="avoiding-common-problems-with-smart-pointers">
<span id="mpcheck-top"></span><h1>Avoiding Common Problems with Smart Pointers<a class="headerlink" href="#avoiding-common-problems-with-smart-pointers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Incorrectly passing allocators when creating or resetting smart pointers
(<code class="docutils literal notranslate"><span class="pre">bslma::ManagedPtr</span></code> and <code class="docutils literal notranslate"><span class="pre">bsl::shared_ptr</span></code>) is the most common mistake made
when using those pointers.</p>
<p>We have added checks to <code class="docutils literal notranslate"><span class="pre">bde_verify</span></code> to detect patterns of misuse and we have
created utility methods to encapsulate passing allocators properly when
creating smart pointer objects.</p>
<p><strong>We recommend using the utility methods</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bslma::ManagedPtrUtil::makeManaged
bslma::ManagedPtrUtil::allocateManaged
bsl::make_shared
bsl::allocate_shared
</pre></div>
</div>
<p>to create smart pointer objects instead of doing so “by hand”.</p>
</div>
<div class="section" id="creating-a-managed-pointer">
<h2>Creating a Managed Pointer<a class="headerlink" href="#creating-a-managed-pointer" title="Permalink to this headline">¶</a></h2>
<p>In full-blown usage, the creation of a managed pointer can involve
three mentions of an allocator.  A typical such case might be -</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">foo</span><span class="p">(</span><span class="n">bslma</span><span class="p">::</span><span class="n">Allocator</span> <span class="o">*</span><span class="n">theAllocator</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="n">bslma</span><span class="p">::</span><span class="n">ManagedPtr</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">smp</span><span class="p">(</span>       <span class="o">//</span> <span class="mi">0</span>
        <span class="n">new</span> <span class="p">(</span><span class="o">*</span><span class="n">theAllocator</span><span class="p">)</span>                   <span class="o">//</span> <span class="mi">1</span>
        <span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">theAllocator</span><span class="p">),</span>  <span class="o">//</span> <span class="mi">2</span>
        <span class="n">theAllocator</span><span class="p">);</span>                        <span class="o">//</span> <span class="mi">3</span>
    <span class="o">//</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We discuss each appearance of the allocator below in
<a class="reference internal" href="#understanding-smart-pointer-construction-and-its-discontents"><span class="std std-doc">understanding smart pointer construction</span></a>.</p>
</div>
<div class="section" id="possibilities-for-error">
<h2>Possibilities for Error<a class="headerlink" href="#possibilities-for-error" title="Permalink to this headline">¶</a></h2>
<p>Whenever the same thing needs to be repeated multiple times,
there is always the possibility of error.</p>
<p>In the case of managed pointer usage, all three allocator
arguments are optional, so erroneous usage may include leaving
out arguments that should have been supplied, causing the default
allocator instead of the supplied allocator to be used.  And since
the supplied allocator very often is the default allocator, such
misuse can go unnoticed for a long time.</p>
</div>
<div class="section" id="bde-verify-checks">
<h2><code class="docutils literal notranslate"><span class="pre">bde_verify</span></code> Checks<a class="headerlink" href="#bde-verify-checks" title="Permalink to this headline">¶</a></h2>
<p>As of version 1.3.12, <code class="docutils literal notranslate"><span class="pre">bde_verify</span></code> contains a check named <code class="docutils literal notranslate"><span class="pre">managed-pointer</span></code>
which attempts to identify possible errors in smart pointer construction
(for both <code class="docutils literal notranslate"><span class="pre">ManagedPtr</span></code> and <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code>, despite the name of the check) and
reset.  They’re described in more
<a class="reference internal" href="#details-of-the-bde-verify-managed-ptr-check"><span class="std std-doc">detail below</span></a>, but in summary,
the’re tagged <code class="docutils literal notranslate"><span class="pre">MP01</span></code>, <code class="docutils literal notranslate"><span class="pre">MP02</span></code>, … and they detect mismatched allocator use.</p>
<p>To run only this check, use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">bde_verify</span> <span class="o">-</span><span class="n">cl</span><span class="o">=</span><span class="s1">&#39;all off&#39;</span> <span class="o">-</span><span class="n">cl</span><span class="o">=</span><span class="s1">&#39;check managed-pointer on&#39;</span> <span class="n">files</span><span class="o">...</span>
</pre></div>
</div>
<p>See the <code class="docutils literal notranslate"><span class="pre">bde_verify</span></code>
<a class="reference external" href="https://bde.bloomberg.com/bde-verify/main.html#synopsis">documentation</a>
for more detail.</p>
</div>
<div class="section" id="avoid-errors-by-using-utilities">
<h2>Avoid Errors by Using Utilities<a class="headerlink" href="#avoid-errors-by-using-utilities" title="Permalink to this headline">¶</a></h2>
<p><strong>BDE 3.44</strong> provides new utility methods for creating managed pointers.
Similar utility methods for shared pointers previously existed.  These methods
encapsulate object creation and the passing of allocators so that the
allocator argument does not need to be repeated,  The methods come in pairs,
a <code class="docutils literal notranslate"><span class="pre">make</span></code> variant that uses the default allocator and an <code class="docutils literal notranslate"><span class="pre">allocate</span></code> variant that
takes a specified allocator.</p>
<p>The example above becomes -</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">bslma</span><span class="p">::</span><span class="n">ManagedPtr</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">smp</span> <span class="o">=</span>
        <span class="n">bslma</span><span class="p">::</span><span class="n">ManagedPtrUtil</span><span class="p">::</span><span class="n">allocateManaged</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span>
            <span class="n">theAllocator</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>If we were creating a shared pointer instead of a managed pointer,
we would say -</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">bsl</span><span class="p">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ssp</span> <span class="o">=</span>
        <span class="n">bsl</span><span class="p">::</span><span class="n">allocate_shared</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">theAllocator</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that we pass the allocator <em>first</em>, followed by the arguments to the
object constructor.  The utility functions query traits of the object type to
determine whether the object uses allocators, and if so, forward the allocator
to the constructor of the object as the last argument.</p>
<p>If we want to use the default allocator, we can say -</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">bslma</span><span class="p">::</span><span class="n">ManagedPtr</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">smp</span> <span class="o">=</span>
        <span class="n">bslma</span><span class="p">::</span><span class="n">ManagedPtrUtil</span><span class="p">::</span><span class="n">makeManaged</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>
    <span class="n">bsl</span><span class="p">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ssp</span> <span class="o">=</span> <span class="n">bsl</span><span class="p">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="understanding-smart-pointer-construction-and-its-discontents">
<h2>Understanding Smart Pointer Construction and Its Discontents<a class="headerlink" href="#understanding-smart-pointer-construction-and-its-discontents" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creating-managed-and-shared-pointers">
<h3>Creating Managed and Shared Pointers<a class="headerlink" href="#creating-managed-and-shared-pointers" title="Permalink to this headline">¶</a></h3>
<p>Here is the code for smart pointer creation, once again -</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">foo</span><span class="p">(</span><span class="n">bslma</span><span class="p">::</span><span class="n">Allocator</span> <span class="o">*</span><span class="n">theAllocator</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="n">bslma</span><span class="p">::</span><span class="n">ManagedPtr</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">smp</span><span class="p">(</span>            <span class="o">//</span> <span class="mi">0</span>
        <span class="n">new</span> <span class="p">(</span><span class="o">*</span><span class="n">theAllocator</span><span class="p">)</span>                        <span class="o">//</span> <span class="mi">1</span>
        <span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">theAllocator</span><span class="p">),</span>       <span class="o">//</span> <span class="mi">2</span>
        <span class="n">theAllocator</span><span class="p">);</span>                             <span class="o">//</span> <span class="mi">3</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="n">bsl</span><span class="p">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ssp</span><span class="p">(</span>              <span class="o">//</span> <span class="mi">0</span>
        <span class="n">new</span> <span class="p">(</span><span class="o">*</span><span class="n">theAllocator</span><span class="p">)</span>                        <span class="o">//</span> <span class="mi">1</span>
        <span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">theAllocator</span><span class="p">),</span>       <span class="o">//</span> <span class="mi">2</span>
        <span class="n">theAllocator</span><span class="p">);</span>                             <span class="o">//</span> <span class="mi">3</span>
    <span class="o">//</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="resetting-managed-and-shared-pointers">
<h3>Resetting Managed and Shared Pointers<a class="headerlink" href="#resetting-managed-and-shared-pointers" title="Permalink to this headline">¶</a></h3>
<p>Resetting a managed pointer is similar -</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">bar</span><span class="p">(</span><span class="n">bslma</span><span class="p">::</span><span class="n">ManagedPtr</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;&amp;</span>  <span class="n">smp</span><span class="p">,</span>
         <span class="n">bsl</span><span class="p">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;&amp;</span>    <span class="n">ssp</span><span class="p">,</span>
         <span class="n">baslma</span><span class="p">::</span><span class="n">Allocator</span>               <span class="o">*</span><span class="n">theAllocator</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="n">smp</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">new</span> <span class="p">(</span><span class="o">*</span><span class="n">theAllocator</span><span class="p">)</span>                    <span class="o">//</span> <span class="mi">1</span>
             <span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">theAllocator</span><span class="p">),</span>   <span class="o">//</span> <span class="mi">2</span>
             <span class="n">theAllocator</span><span class="p">);</span>                         <span class="o">//</span> <span class="mi">3</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="n">ssp</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">new</span> <span class="p">(</span><span class="o">*</span><span class="n">theAllocator</span><span class="p">)</span>                   <span class="o">//</span> <span class="mi">1</span>
              <span class="n">bsl</span><span class="p">::</span><span class="n">string</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">theAllocator</span><span class="p">),</span>  <span class="o">//</span> <span class="mi">2</span>
              <span class="n">theAllocator</span><span class="p">);</span>                        <span class="o">//</span> <span class="mi">3</span>
    <span class="o">//</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-allocator-arguments">
<h3>The Allocator Arguments<a class="headerlink" href="#the-allocator-arguments" title="Permalink to this headline">¶</a></h3>
<p>At line 0 we create a smart pointer to string.</p>
<p>At line 1, we issue the <code class="docutils literal notranslate"><span class="pre">new</span></code> expression to allocate the string
that will be held by the managed pointer, passing it the
placement argument <code class="docutils literal notranslate"><span class="pre">(*theAllocator)</span></code> so that it will use the
specified allocator to allocate memory for the string.</p>
<p>At line 2, we pass the allocator to the string constructor so
that the string will use that allocator for its internal memory
allocation; the fact that the string itself was allocated using
a particular allocator does not automatically forward that
allocator to the string.  Without this argument, the string would
use the default allocator for its internal allocations.</p>
<p>Finally, at line 3 we pass the allocator to the managed pointer
constructor to use as the means for deallocating the held string.
Deallocation must match allocation; since memory for the held string
came from <code class="docutils literal notranslate"><span class="pre">theAllocator</span></code> (at line 1), we must use <code class="docutils literal notranslate"><span class="pre">theAllocator</span></code> to
free that memory.</p>
</div>
<div class="section" id="consequences-of-omission-or-mismatch">
<h3>Consequences of Omission or Mismatch<a class="headerlink" href="#consequences-of-omission-or-mismatch" title="Permalink to this headline">¶</a></h3>
<p>Leaving out the allocator at line 2, or using a different one, is
the least pernicious.  It results in the string using a different
allocator from the one used to allocate the string.  This is not an
error per se, but it may lead to inefficiency by failing to take
advantage of the presumably more performant supplied allocator.</p>
<p>Leaving out the placement argument at line 1 or the deleter argument
at line 3 is the most troublesome, since it implies that the wrong
method will be used to deallocate memory.  However, the default allocator,
unless reset, allocates and frees memory using <code class="docutils literal notranslate"><span class="pre">operator</span> <span class="pre">new</span></code> and
<code class="docutils literal notranslate"><span class="pre">operator</span> <span class="pre">delete</span></code>, so omitting one of line 1 and line 3 can still result in
code that “works” until a non-default allocator is supplied.</p>
<p>And obviously, actual mismatches between line 1 and line 3 will cause
errors if the deleter attempts to free memory in a way inconsistent
with how the allocator supplied it.</p>
</div>
</div>
<div class="section" id="details-of-the-bde-verify-managed-ptr-check">
<h2>Details of the <code class="docutils literal notranslate"><span class="pre">bde_verify</span></code> <code class="docutils literal notranslate"><span class="pre">managed-ptr</span></code> Check<a class="headerlink" href="#details-of-the-bde-verify-managed-ptr-check" title="Permalink to this headline">¶</a></h2>
<p>Examples of the output it produces follow -</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">MP01</span><span class="p">:</span> <span class="n">Shared</span> <span class="n">pointer</span> <span class="n">without</span> <span class="n">deleter</span>
      <span class="n">will</span> <span class="n">use</span> <span class="s1">&#39;operator delete&#39;</span>
    <span class="n">ManagedPtr</span><span class="o">&lt;</span><span class="n">char</span><span class="o">&gt;</span> <span class="n">mp02</span><span class="p">(</span><span class="n">new</span> <span class="p">(</span><span class="o">*</span><span class="n">pa</span><span class="p">)</span> <span class="n">char</span><span class="p">);</span>
                     <span class="o">^</span>    <span class="o">~~~~~~~~~~~~~~</span>

<span class="n">file</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">72</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">MP02</span><span class="p">:</span> <span class="n">Different</span> <span class="n">allocator</span> <span class="ow">and</span> <span class="n">deleter</span>
      <span class="k">for</span> <span class="n">shared</span> <span class="n">pointer</span>
    <span class="n">ManagedPtr</span><span class="o">&lt;</span><span class="n">char</span><span class="o">&gt;</span> <span class="n">ep03</span><span class="p">(</span><span class="n">new</span> <span class="p">(</span><span class="n">ta</span><span class="p">)</span> <span class="n">char</span><span class="p">,</span> <span class="n">ba</span><span class="p">);</span>
                     <span class="o">^</span>         <span class="o">~~</span>        <span class="o">~~</span>

<span class="n">file</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">70</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">MP03</span><span class="p">:</span> <span class="n">Deleter</span> <span class="n">provided</span> <span class="k">for</span> <span class="n">non</span><span class="o">-</span><span class="n">placement</span>
      <span class="n">allocation</span> <span class="k">for</span> <span class="n">shared</span> <span class="n">pointer</span>
    <span class="n">ManagedPtr</span><span class="o">&lt;</span><span class="n">char</span><span class="o">&gt;</span> <span class="n">ep01</span><span class="p">(</span><span class="n">new</span> <span class="n">char</span><span class="p">,</span> <span class="n">da</span><span class="p">);</span>
                     <span class="o">^</span>    <span class="o">~~~~~~~~</span>  <span class="o">~~</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">bde_verify</span></code> attempts to detect if an allocator variable has been initialized
to the default allocator explicitly, and if so issues a gentler warning, off
by default -</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">MPOK01</span><span class="p">:</span> <span class="n">Shared</span> <span class="n">pointer</span> <span class="n">without</span> <span class="n">deleter</span>
      <span class="n">using</span> <span class="n">default</span><span class="o">-</span><span class="n">initialized</span> <span class="n">allocator</span> <span class="n">variable</span>
    <span class="n">ManagedPtr</span><span class="o">&lt;</span><span class="n">char</span><span class="o">&gt;</span> <span class="n">mp04</span><span class="p">(</span><span class="n">new</span> <span class="p">(</span><span class="o">*</span><span class="n">da</span><span class="p">)</span> <span class="n">char</span><span class="p">);</span>
                     <span class="o">^</span>         <span class="o">~~~</span>
<span class="n">file</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="n">MPOK01</span><span class="p">:</span> <span class="n">Initialization</span> <span class="ow">is</span> <span class="n">here</span>
    <span class="n">bslma</span><span class="p">::</span><span class="n">Allocator</span>     <span class="o">*</span><span class="n">da</span> <span class="o">=</span> <span class="n">bslma</span><span class="p">::</span><span class="n">Default</span><span class="p">::</span><span class="n">allocator</span><span class="p">();</span>
                          <span class="o">^</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2024, Bloomberg LP.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>