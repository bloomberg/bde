<!doctype HTML public "-//W3C//DTD HTML 4.0 Frameset//EN">
<html>
<title>BDE 2.23.1 OSS</title>
<html>
<pre>
// bslx_versionfunctions.h                                            -*-C++-*-
#ifndef INCLUDED_BSLX_VERSIONFUNCTIONS
#define INCLUDED_BSLX_VERSIONFUNCTIONS

#ifndef INCLUDED_BSLS_IDENT
#include &lt;bsls_ident.h&gt;
#endif
BSLS_IDENT(&quot;$Id: $&quot;)

//@PURPOSE: Provide functions to return BDEX version information for types.
//
//@CLASSES:
//  bslx::VersionFunctions: namespace for functions returning version numbers
//
//@DESCRIPTION: This component provides a namespace, &#39;bslx::VersionFunctions&#39;,
// that contains functions for determining the BDEX version number for types.
//
// This namespace defines the &#39;maxSupportedBdexVersion&#39; function, which is
// overloaded to return a predetermined value, &#39;k_NO_VERSION&#39;, also defined in
// this namespace, for each of the fundamental types, &#39;enum&#39; types, and
// &#39;bsl::string&#39;.  For &#39;bsl::vector&#39;, the &#39;maxSupportedBdexVersion&#39; function
// returns 1 if the vector is parameterized on one of the three types mentioned
// above.  Otherwise, the version number returned is the same as that returned
// for &#39;bsl::vector::value_type&#39;.  For BDEX-compliant types, the function
// returns the BDEX version number returned by the &#39;maxSupportedBdexVersion&#39;
// method provided by that type.
//
// In general, this component is used by higher-level &#39;bslx&#39; components to
// query the version number for types.
//
///Usage
///-----
// This section illustrates intended use of this component.
//
///Example 1: Querying BDEX Version
///- - - - - - - - - - - - - - - -
// This component may be used by clients to query the version number for types
// in a convenient manner.  First, define an &#39;enum&#39;, &#39;my_Enum&#39;:
//..
//  enum my_Enum {
//      ENUM_VALUE1,
//      ENUM_VALUE2,
//      ENUM_VALUE3,
//      ENUM_VALUE4
//  };
//..
// Then, define a BDEX-compliant class, &#39;my_Class&#39;:
//..
//  class my_Class {
//    public:
//      enum {
//          VERSION = 1
//      };
//
//      // CLASS METHODS
//      static int maxSupportedBdexVersion(int) {
//          return VERSION;
//      }
//
//      //...
//
//  };
//..
// Finally, verify the value returned by &#39;maxSupportedBdexVersion&#39; for some
// fundamental types, &#39;my_Enum&#39;, and &#39;my_Class&#39; with an arbitrary
// &#39;versionSelector&#39;:
//..
//  using bslx::VersionFunctions::maxSupportedBdexVersion;
//  using bslx::VersionFunctions::k_NO_VERSION;
//
//  assert(k_NO_VERSION ==
//      maxSupportedBdexVersion(reinterpret_cast&lt;char        *&gt;(0), 20131127));
//  assert(k_NO_VERSION ==
//      maxSupportedBdexVersion(reinterpret_cast&lt;int         *&gt;(0), 20131127));
//  assert(k_NO_VERSION ==
//      maxSupportedBdexVersion(reinterpret_cast&lt;double      *&gt;(0), 20131127));
//  assert(k_NO_VERSION ==
//      maxSupportedBdexVersion(reinterpret_cast&lt;bsl::string *&gt;(0), 20131127));
//
//  assert(k_NO_VERSION ==
//      maxSupportedBdexVersion(reinterpret_cast&lt;my_Enum     *&gt;(0), 20131127));
//
//  assert(my_Class::VERSION ==
//      maxSupportedBdexVersion(reinterpret_cast&lt;my_Class    *&gt;(0), 20131127));
//..

#ifndef INCLUDED_BSLSCM_VERSION
#include &lt;bslscm_version.h&gt;
#endif

#ifndef INCLUDED_BSLMF_IF
#include &lt;bslmf_if.h&gt;
#endif

#ifndef INCLUDED_BSLMF_ISENUM
#include &lt;bslmf_isenum.h&gt;
#endif

#ifndef INCLUDED_BSLMF_ISFUNDAMENTAL
#include &lt;bslmf_isfundamental.h&gt;
#endif

#ifndef INCLUDED_BSLMF_ISSAME
#include &lt;bslmf_issame.h&gt;
#endif

#ifndef INCLUDED_BSLMF_REMOVECV
#include &lt;bslmf_removecv.h&gt;
#endif

#ifndef INCLUDED_BSL_STRING
#include &lt;bsl_string.h&gt;
#endif

#ifndef INCLUDED_BSL_VECTOR
#include &lt;bsl_vector.h&gt;
#endif

namespace BloombergLP {
namespace bslx {

                 // =============================================
                 // class VersionFunctions_DoesNotHaveBdexVersion
                 // =============================================

class VersionFunctions_DoesNotHaveBdexVersion {
    // This class is used to perform function overload resolution for types
    // that do *not* have BDEX versions.  This class contains no interface or
    // implementation by design.
};

                 // =====================================
                 // class VersionFunctions_HasBdexVersion
                 // =====================================

class VersionFunctions_HasBdexVersion {
    // This class is used to perform function overload resolution for types
    // that *have* BDEX versions.  This class contains no interface or
    // implementation by design.
};

                 // ==========================================
                 // struct VersionFunctions_NonFundamentalImpl
                 // ==========================================

template &lt;class TYPE&gt;
struct VersionFunctions_NonFundamentalImpl {
    // This &#39;struct&#39; provides a namespace for functions used to obtain the
    // BDEX-compliant version information for vectors and types requiring a
    // &#39;TYPE::maxSupportedBdexVersion&#39; method as per the BDEX protocol (see the
    // &#39;bslx&#39; package-level documentation).

    static int maxSupportedBdexVersion(int versionSelector);
        // Return the maximum valid BDEX format version, as indicated by the
        // specified &#39;versionSelector&#39;, to be passed to the &#39;bdexStreamOut&#39;
        // method while streaming an object of the (template parameter) type
        // &#39;TYPE&#39;.  Note that it is highly recommended that &#39;versionSelector&#39;
        // be formatted as &quot;YYYYMMDD&quot;, a date representation.  Also note that
        // &#39;versionSelector&#39; should be a *compile*-time-chosen value that
        // selects a format version supported by both externalizer and
        // unexternalizer.  See the &#39;bslx&#39; package-level documentation for more
        // information on BDEX streaming of value-semantic types and
        // containers.
};

template &lt;class TYPE, class ALLOC&gt;
struct VersionFunctions_NonFundamentalImpl&lt;bsl::vector&lt;TYPE, ALLOC&gt; &gt; {
    static int maxSupportedBdexVersion(int versionSelector);
        // Return the maximum valid BDEX format version, as indicated by the
        // specified &#39;versionSelector&#39;, to be passed to the &#39;bdexStreamOut&#39;
        // method while streaming an object of the (template parameter) type
        // &#39;bsl::vector&lt;TYPE, ALLOC&gt;&#39;.  Note that it is highly recommended that
        // &#39;versionSelector&#39; be formatted as &quot;YYYYMMDD&quot;, a date representation.
        // Also note that &#39;versionSelector&#39; should be a *compile*-time-chosen
        // value that selects a format version supported by both externalizer
        // and unexternalizer.  See the &#39;bslx&#39; package-level documentation for
        // more information on BDEX streaming of value-semantic types and
        // containers.
};

                         // ===============================
                         // namespace VersionFunctions_Impl
                         // ===============================

namespace VersionFunctions_Impl {
    // This namespace contains functions that allow the computation of version
    // information for a (template parameter) type &#39;TYPE&#39; as per the BDEX
    // protocol (see the &#39;bslx&#39; package-level documentation).  These functions
    // presume that all &#39;const&#39; and &#39;volatile&#39; qualifiers have been stripped
    // from the (template parameter) &#39;TYPE&#39;.

    // CLASS METHODS
    template &lt;class TYPE&gt;
    int maxSupportedBdexVersion(
                               int,
                               const VersionFunctions_DoesNotHaveBdexVersion&amp;);
        // Return &#39;k_NO_VERSION&#39;.  Note that this function is called only for
        // enumerations, fundamental types, and &#39;bsl::string&#39;, which do not
        // require versioning as per the BDEX protocol.

    template &lt;class TYPE&gt;
    int maxSupportedBdexVersion(
                        int                                    versionSelector,
                        const VersionFunctions_HasBdexVersion&amp;);
        // Return the maximum valid BDEX format version, as indicated by the
        // specified &#39;versionSelector&#39;, to be passed to the &#39;bdexStreamOut&#39;
        // method while streaming an object of the (template parameter) type
        // &#39;TYPE&#39;.  Note that it is highly recommended that &#39;versionSelector&#39;
        // be formatted as &quot;YYYYMMDD&quot;, a date representation.  Also note that
        // &#39;versionSelector&#39; should be a *compile*-time-chosen value that
        // selects a format version supported by both externalizer and
        // unexternalizer.  Also note that this function assumes the &#39;TYPE&#39; is
        // neither &#39;const&#39; nor &#39;volatile&#39; and that this function is called only
        // for types which are not enumerations, not fundamental types, and not
        // &#39;bsl::string&#39; (vectors and other BDEX-compliant types will use this
        // function).  See the &#39;bslx&#39; package-level documentation for more
        // information on BDEX streaming of value-semantic types and
        // containers.

    template &lt;class TYPE&gt;
    int maxSupportedBdexVersion(int versionSelector);
        // Return the maximum valid BDEX format version, as indicated by the
        // specified &#39;versionSelector&#39;, to be passed to the &#39;bdexStreamOut&#39;
        // method while streaming an object of the (template parameter) type
        // &#39;TYPE&#39;.  Note that it is highly recommended that &#39;versionSelector&#39;
        // be formatted as &quot;YYYYMMDD&quot;, a date representation.  Also note that
        // &#39;versionSelector&#39; should be a *compile*-time-chosen value that
        // selects a format version supported by both externalizer and
        // unexternalizer.  Also note that this function assumes the &#39;TYPE&#39; is
        // neither &#39;const&#39; nor &#39;volatile&#39;.  See the &#39;bslx&#39; package-level
        // documentation for more information on BDEX streaming of
        // value-semantic types and containers.

}  // close VersionFunctions_Impl namespace

                         // ==========================
                         // namespace VersionFunctions
                         // ==========================

namespace VersionFunctions {
    // This namespace contains functions that allow the computation of version
    // information for a (template parameter) type &#39;TYPE&#39; as per the BDEX
    // protocol (see the &#39;bslx&#39; package-level documentation).

    enum {
        k_NO_VERSION = -1  // Value to be used when there is no BDEX version.
    };

    // CLASS METHODS
    template &lt;class TYPE&gt;
    int maxSupportedBdexVersion(const TYPE *, int versionSelector);
        // Return the maximum valid BDEX format version, as indicated by the
        // specified &#39;versionSelector&#39;, to be passed to the &#39;bdexStreamOut&#39;
        // method while streaming an object of the (template parameter) type
        // &#39;TYPE&#39;.  Note that it is highly recommended that &#39;versionSelector&#39;
        // be formatted as &quot;YYYYMMDD&quot;, a date representation.  Also note that
        // &#39;versionSelector&#39; should be a *compile*-time-chosen value that
        // selects a format version supported by both externalizer and
        // unexternalizer.  Also note that this function ignores any &#39;const&#39;
        // and &#39;volatile&#39; qualifiers on the &#39;TYPE&#39;.  See the &#39;bslx&#39;
        // package-level documentation for more information on BDEX streaming
        // of value-semantic types and containers.

}  // close VersionFunctions namespace

// ============================================================================
//                          INLINE DEFINITIONS
// ============================================================================

                 // ------------------------------------------
                 // struct VersionFunctions_NonFundamentalImpl
                 // ------------------------------------------

// CLASS METHODS
template &lt;class TYPE&gt;
inline
int VersionFunctions_NonFundamentalImpl&lt;TYPE&gt;::
                                   maxSupportedBdexVersion(int versionSelector)
{
    // A compilation error indicating the next line of code implies the class
    // of &#39;TYPE&#39; does not support the &#39;maxSupportedBdexVersion&#39; method.

    return TYPE::maxSupportedBdexVersion(versionSelector);
}

template &lt;class TYPE, class ALLOC&gt;
inline
int VersionFunctions_NonFundamentalImpl&lt;bsl::vector&lt;TYPE, ALLOC&gt; &gt;::
                                   maxSupportedBdexVersion(int versionSelector)
{
    using VersionFunctions::maxSupportedBdexVersion;

    const int version = maxSupportedBdexVersion(reinterpret_cast&lt;TYPE *&gt;(0),
                                                versionSelector);

    return version != VersionFunctions::k_NO_VERSION ? version : 1;
}

                        // -------------------------------
                        // namespace VersionFunctions_Impl
                        // -------------------------------

template &lt;class TYPE&gt;
inline
int VersionFunctions_Impl::maxSupportedBdexVersion(
                                int,
                                const VersionFunctions_DoesNotHaveBdexVersion&amp;)
{
    return VersionFunctions::k_NO_VERSION;
}

template &lt;class TYPE&gt;
inline
int VersionFunctions_Impl::maxSupportedBdexVersion(
                        int                                    versionSelector,
                        const VersionFunctions_HasBdexVersion&amp;)
{
    return VersionFunctions_NonFundamentalImpl&lt;TYPE&gt;::
                                      maxSupportedBdexVersion(versionSelector);
}

template &lt;class TYPE&gt;
inline
int VersionFunctions_Impl::maxSupportedBdexVersion(int versionSelector)
{
    typedef typename bslmf::If&lt;bslmf::IsFundamental&lt;TYPE&gt;::value
                               || bslmf::IsEnum&lt;TYPE&gt;::value
                               || bsl::is_same&lt;TYPE, bsl::string&gt;::value,
                               VersionFunctions_DoesNotHaveBdexVersion,
                               VersionFunctions_HasBdexVersion&gt;::Type
                                                                     dummyType;

    return VersionFunctions_Impl::
                   maxSupportedBdexVersion&lt;TYPE&gt;(versionSelector, dummyType());
}

                        // --------------------------
                        // namespace VersionFunctions
                        // --------------------------

template &lt;class TYPE&gt;
inline
int VersionFunctions::maxSupportedBdexVersion(const TYPE *,
                                              int         versionSelector)
{
    return VersionFunctions_Impl::
                  maxSupportedBdexVersion&lt;typename bsl::remove_cv&lt;TYPE&gt;::type&gt;(
                                                              versionSelector);
}

}  // close package namespace
}  // close enterprise namespace

#endif

// ----------------------------------------------------------------------------
// Copyright 2014 Bloomberg Finance L.P.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// ----------------------------- END-OF-FILE ----------------------------------
</pre>
</body>
</html>
